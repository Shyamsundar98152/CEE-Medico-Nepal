<!DOCTYPE html>
<html lang="en">
<head>
    <!-- We load Tailwind CSS for modern, adaptive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CEE Medico Chapter Quiz (Secure)</title>
    <style>
        /* Base Styles (Custom CSS for the theme/look of the original app) */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter for modern feel */
            margin: 0;
            background: #f1f5f9; /* Light slate background */
            line-height: 1.6;
            color: #1f2937; /* Darker text */
        }
        header {
            background-color: #003366; /* Deep Blue */
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 2.25em; }
        nav { display: flex; justify-content: center; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
        nav a { color: white; text-decoration: none; font-weight: 600; padding: 8px 15px; border-radius: 6px; transition: background-color 0.3s ease; }
        nav a:hover { background-color: #004488; }
        main {
            max-width: 900px;
            margin: 25px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            color: #003366;
            margin-bottom: 25px;
            font-size: 1.8em;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        /* Custom styling for inputs and buttons (enhanced with shadows/radius) */
        input[type="text"], button {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .option-btn {
            display: block;
            padding: 15px;
            margin: 10px 0;
            background-color: #e3f2fd; /* Light Blue */
            border: 1px solid #90caf9;
            cursor: pointer;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            border-radius: 8px;
            font-size: 1.1em;
            color: #003366;
        }
        .option-btn:hover {
            background-color: #bbdefb;
            border-color: #64b5f6;
        }
        .hidden { display: none; }
        #explanation {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.4;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #explanation.correct { color: #15803d; background-color: #dcfce7; }
        #explanation.incorrect { color: #dc2626; background-color: #fee2e2; }
        #question-text { font-size: 1.3em; margin-bottom: 20px; color: #1f2937; font-weight: 600; }
        #quiz-results { padding: 25px; background-color: #f0f8ff; border: 1px solid #bfdbfe; border-radius: 10px; text-align: center; }
        .score-correct { color: #15803d; }
        .score-wrong { color: #dc2626; }
        .navigation-buttons button {
            padding: 10px 20px !important;
            border-radius: 9999px; /* Pill shape */
            font-weight: bold;
            text-transform: uppercase;
        }
        #error-message {
            color: #dc2626;
            background-color: #fee2e2;
            padding: 10px;
            margin-top: 15px;
            border-radius: 6px;
            text-align: center;
        }

        /* Responsive Adjustments (Using Tailwind concepts via CSS) */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.5em; }
            main { margin: 15px; padding: 20px; }
            nav { flex-direction: column; gap: 8px; }
            .navigation-buttons { flex-wrap: wrap; }
            .navigation-buttons button { width: 100%; margin-bottom: 8px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>CEE Medico Nepal</h1>
        <nav>
            <a href="#">Home</a>
            <a href="#">About</a>
            <a href="#">Premium</a>
            <a href="#">Login</a>
        </nav>
    </header>

    <main>
        <div id="auth-status" class="text-xs text-right text-gray-500 mb-4">
            Initializing secure session...
        </div>

        <h2>📘 Chapter Quiz Questions</h2>
        <input type="text" id="chapter" placeholder="Enter Chapter Name (e.g., Laws of Motion)" class="w-full p-3 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
        <button id="load-quiz-btn" onclick="loadOrGenerateQuiz()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg">
            Load Quiz
        </button>
        <div id="error-message" class="hidden"></div>

        <div id="quiz-container" class="hidden mt-6 p-4 border border-gray-200 rounded-lg">
            <div id="countdown-timer"></div>
            <div id="question-num"></div>
            <div id="question-text"></div>
            <div id="options-container"></div>
            <p id="explanation" class="hidden"></p>
            <div class="navigation-buttons">
                <button id="previous-button" onclick="previousQuestion()" class="bg-gray-500 hover:bg-gray-600">Previous</button>
                <button id="skip-button" onclick="skipQuestion()" class="bg-yellow-500 hover:bg-yellow-600">Skip</button>
                <button id="next-button" onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-700">Next</button>
                <button id="submit-button" class="hidden bg-green-600 hover:bg-green-700" onclick="submitQuiz()">Submit Quiz</button>
            </div>
        </div>

        <div id="quiz-results" class="hidden">
            <h3>Quiz Results</h3>
            <p>Total Questions: <span id="total-questions-result"></span></p>
            <p class="score-correct">Correct Answers: <span id="correct-answers-result"></span></p>
            <p class="score-wrong">Wrong Answers: <span id="wrong-answers-result"></span></p>
            <p>Skipped Questions: <span id="skipped-questions-result"></span></p>
            <p class="mt-4 text-2xl font-extrabold text-blue-800">Your Score: <span id="final-score-result"></span> / <span id="max-score-result"></span></p>
            <button onclick="location.reload()" class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg">Start New Quiz</button>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 CEE Medico Nepal. All rights reserved.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // 1. MANDATORY GLOBAL VARIABLE INITIALIZATION
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let quizData = [];
        let currentIndex = 0;
        let countdownInterval;
        const TIMER_SECONDS = 30; // Time per question
        
        // Use an empty string for the API key, as the runtime environment will handle it.
        const GEMINI_API_KEY = ""; 

        // Utility to display non-blocking errors
        function displayError(message) {
            const errorElement = document.getElementById("error-message");
            errorElement.innerText = message;
            errorElement.classList.remove("hidden");
            setTimeout(() => errorElement.classList.add("hidden"), 5000);
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            setLogLevel('debug'); // Enable Firestore debug logging
            const authStatus = document.getElementById("auth-status");
            authStatus.innerText = "Connecting to Firebase...";

            if (!firebaseConfig) {
                authStatus.innerText = "Error: Firebase configuration missing.";
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatus.innerText = "Authenticating user...";

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.innerHTML = `✅ Session ready. User ID: <span class="font-mono text-xs">${userId}</span>`;
                        // Now that auth is ready, we can proceed with data operations if needed.
                    } else {
                        userId = null;
                        authStatus.innerText = "Authentication failed or not ready.";
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatus.innerText = `🚨 Firebase connection failed: ${error.message}`;
            }
        }
        
        // Run initialization on load
        initializeFirebase();


        /**
         * Constructs the secure, private Firestore document reference path.
         * Path: /artifacts/{appId}/users/{userId}/quizzes/{chapterId}
         */
        function getQuizDocRef(chapterId) {
            if (!userId) {
                throw new Error("User not authenticated. Cannot access Firestore.");
            }
            // Secure Private Path: /artifacts/{appId}/users/{userId}/
            const securePath = `artifacts/${appId}/users/${userId}/quizzes`;
            return doc(db, securePath, chapterId);
        }

        // --- Quiz Logic ---

        async function loadOrGenerateQuiz() {
            const chapterInput = document.getElementById("chapter").value.trim();
            if (!chapterInput || !userId) {
                displayError("Please enter a chapter name and ensure authentication is ready.");
                return;
            }
            
            const chapterId = chapterInput.toLowerCase().replace(/\s+/g, '-');
            const generateButton = document.getElementById("load-quiz-btn");
            generateButton.innerText = "Loading...";
            generateButton.disabled = true;
            
            try {
                const docRef = getQuizDocRef(chapterId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log("✅ Quiz loaded from Firestore cache!");
                    const data = docSnap.data();
                    if (data && Array.isArray(data.questions)) {
                        quizData = data.questions.map(q => ({
                            ...q,
                            userAnswerIndex: q.userAnswerIndex !== undefined ? q.userAnswerIndex : null,
                            isAnswered: q.isAnswered !== undefined ? q.isAnswered : false,
                            isSkipped: q.isSkipped !== undefined ? q.isSkipped : false
                        }));
                    } else {
                        console.warn("Cached data is malformed. Fetching new quiz.");
                        throw new Error("Cached data invalid.");
                    }
                } else {
                    console.log("ℹ️ No quiz in cache. Generating with API...");
                    const newQuiz = await generateQuizFromAPI(chapterInput);
                    if (newQuiz && newQuiz.length > 0) {
                        quizData = newQuiz;
                        await saveQuizToFirestore(chapterId, quizData);
                    } else {
                        displayError("❌ Failed to generate questions from the API. Try a different chapter name.");
                        return;
                    }
                }
                
                currentIndex = 0;
                document.getElementById("quiz-results").classList.add("hidden");
                showQuestion();

            } catch (err) {
                if (err.message.includes("Cached data invalid") || err.message.includes("User not authenticated")) {
                    // Try API fallback if cache failed or user wasn't ready
                    if (!userId) {
                         displayError("Authentication is not ready. Please wait a moment and try again.");
                         return;
                    }
                    try {
                        console.log("Falling back to API generation...");
                        const newQuiz = await generateQuizFromAPI(chapterInput);
                        if (newQuiz && newQuiz.length > 0) {
                            quizData = newQuiz;
                            await saveQuizToFirestore(chapterId, quizData);
                            currentIndex = 0;
                            document.getElementById("quiz-results").classList.add("hidden");
                            showQuestion();
                        } else {
                            displayError("❌ Error fetching quiz. Check chapter name and console logs.");
                        }
                    } catch (apiErr) {
                        displayError("❌ Error fetching new quiz: " + apiErr.message);
                        console.error("API fallback error:", apiErr);
                    }
                } else {
                    displayError("❌ An error occurred: " + err.message);
                    console.error("Error loading/generating quiz:", err);
                }
            } finally {
                generateButton.innerText = "Load Quiz";
                generateButton.disabled = false;
            }
        }
        window.loadOrGenerateQuiz = loadOrGenerateQuiz;

        async function generateQuizFromAPI(chapter) {
            if (chapter.length > 100) {
                displayError("Chapter name is too long.");
                return null;
            }

            // Using the recommended model for structured output
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const prompt = `
Generate 10 NEET and CEE-Hard level multiple choice questions in JSON format on the chapter "${chapter}" based on NEB and MEC syllabus Nepal. The current date is ${new Date().toLocaleDateString('en-CA')}. Use this exact format:
[
  {
    "question": "1. Sample question?",
    "options": ["A) Option A", "B) Option B", "C) Option C", "D) Option D"],
    "correct": 1,
    "explanation": "Explanation here."
  }
]
Ensure the output is only the JSON array and nothing else.
`;
            // Define the strict JSON structure for the API
            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        question: { type: "STRING" },
                        options: { type: "ARRAY", items: { type: "STRING" } },
                        correct: { type: "INTEGER", description: "The 0-based index of the correct option (0 for A, 1 for B, etc.)" },
                        explanation: { type: "STRING" }
                    },
                    required: ["question", "options", "correct", "explanation"]
                }
            };

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorBody.error.message || 'Unknown error'}`);
                }

                const result = await response.json();
                const rawJson = result.candidates[0].content.parts[0].text;
                
                // Add initial state to the generated questions
                return JSON.parse(rawJson).map(q => ({
                    ...q,
                    userAnswerIndex: null, isAnswered: false, isSkipped: false
                }));

            } catch (err) {
                console.error("API generation error:", err);
                throw new Error("Failed to generate quiz from API. Details in console.");
            }
        }
        
        async function saveQuizToFirestore(chapterId, quizContent) {
            try {
                const docRef = getQuizDocRef(chapterId);
                // We serialize the quizContent array because Firestore prefers flat objects/arrays of primitives
                // The structure is simple enough that direct storage should be fine, but we ensure proper structure.
                await setDoc(docRef, {
                    questions: quizContent.map(q => ({
                         question: q.question,
                         options: q.options,
                         correct: q.correct,
                         explanation: q.explanation,
                         userAnswerIndex: q.userAnswerIndex,
                         isAnswered: q.isAnswered,
                         isSkipped: q.isSkipped
                    })),
                    chapter: chapterId,
                    createdAt: serverTimestamp()
                });
                console.log("✅ Quiz successfully saved to secure Firestore path!");
            } catch (error) {
                console.error("❌ Error saving quiz to Firestore: ", error);
            }
        }

        // --- UI and Navigation Logic ---

        function startCountdown() {
            let timeLeft = TIMER_SECONDS;
            const timerDisplay = document.getElementById("countdown-timer");
            timerDisplay.classList.remove("hidden");

            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                timerDisplay.innerText = `Time left: ${timeLeft}s`;
                if (timeLeft <= 5) {
                    timerDisplay.style.color = '#dc2626'; // Red
                } else {
                    timerDisplay.style.color = '#d32f2f'; // Original Red
                }

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    timerDisplay.innerText = "Time's up! Skipped.";
                    // Only skip if the current question hasn't been answered yet
                    if(currentIndex < quizData.length && !quizData[currentIndex].isAnswered) {
                        quizData[currentIndex].isSkipped = true;
                    }
                    nextQuestion(); // Move to the next question automatically
                }
                timeLeft--;
            }, 1000);
        }

        function showQuestion() {
            document.getElementById("quiz-results").classList.add("hidden");
            document.getElementById("quiz-container").classList.remove("hidden");

            // Update navigation button visibility
            const prevBtn = document.getElementById("previous-button");
            const nextBtn = document.getElementById("next-button");
            const skipBtn = document.getElementById("skip-button");
            const submitBtn = document.getElementById("submit-button");

            prevBtn.disabled = currentIndex === 0;

            if (currentIndex >= quizData.length - 1) {
                nextBtn.classList.add("hidden");
                skipBtn.classList.add("hidden");
                submitBtn.classList.remove("hidden");
            } else {
                nextBtn.classList.remove("hidden");
                skipBtn.classList.remove("hidden");
                submitBtn.classList.add("hidden");
            }

            if (currentIndex >= quizData.length) {
                submitQuiz();
                return;
            }

            const q = quizData[currentIndex];
            document.getElementById("question-num").innerText = `Question ${currentIndex + 1} of ${quizData.length}`;
            document.getElementById("question-text").innerText = q.question;
            
            const explanationElement = document.getElementById("explanation");
            explanationElement.innerText = "";
            explanationElement.className = "";
            explanationElement.classList.add("hidden");

            const optionsBox = document.getElementById("options-container");
            optionsBox.innerHTML = "";

            q.options.forEach((opt, i) => {
                const btn = document.createElement("button");
                btn.innerText = opt;
                btn.className = "option-btn";
                btn.onclick = () => selectOption(i);
                optionsBox.appendChild(btn);
            });

            // Handle pre-answered state
            if (q.isAnswered || q.isSkipped) {
                Array.from(optionsBox.children).forEach(optionBtn => optionBtn.disabled = true);
                if (q.isAnswered) {
                    highlightAnswer(q.userAnswerIndex, q.correct);
                    const isCorrect = q.userAnswerIndex === q.correct;
                    explanationElement.innerText = (isCorrect ? "✅ Correct! " : `❌ Incorrect! Correct: ${q.options[q.correct]}. `) + (q.explanation || "No explanation provided.");
                    explanationElement.classList.add(isCorrect ? "correct" : "incorrect");
                } else if (q.isSkipped) {
                    explanationElement.innerText = "This question was skipped. (No answer recorded)";
                    explanationElement.classList.add("incorrect");
                }
                explanationElement.classList.remove("hidden");
                clearInterval(countdownInterval);
                document.getElementById("countdown-timer").classList.add("hidden");
            } else {
                startCountdown();
            }
        }

        function selectOption(selectedIndex) {
            const q = quizData[currentIndex];
            if (q.isAnswered) return;
            
            // Record answer
            q.isAnswered = true;
            q.userAnswerIndex = selectedIndex;
            q.isSkipped = false;
            
            highlightAnswer(selectedIndex, q.correct);
            
            const explanationElement = document.getElementById("explanation");
            const isCorrect = selectedIndex === q.correct;
            explanationElement.innerText = (isCorrect ? "✅ Correct! " : `❌ Incorrect! Correct: ${q.options[q.correct]}. `) + (q.explanation || "No explanation provided.");
            explanationElement.classList.add(isCorrect ? "correct" : "incorrect");
            explanationElement.classList.remove("hidden");

            Array.from(document.getElementById("options-container").children).forEach(btn => btn.disabled = true);
            clearInterval(countdownInterval);
            document.getElementById("countdown-timer").classList.add("hidden");

            // Optionally, save state back to Firestore after an answer
            saveQuizToFirestore(document.getElementById("chapter").value.trim().toLowerCase().replace(/\s+/g, '-'), quizData);
        }
        window.selectOption = selectOption;

        function highlightAnswer(selectedIndex, correctIndex) {
            const optionsBox = document.getElementById("options-container");
            const options = optionsBox.children;
            if (selectedIndex !== correctIndex) {
                options[selectedIndex].style.backgroundColor = '#fecaca'; // Red 200
                options[selectedIndex].style.borderColor = '#ef4444'; // Red 500
            }
            options[correctIndex].style.backgroundColor = '#dcfce7'; // Green 100
            options[correctIndex].style.borderColor = '#10b981'; // Green 500
        }

        function nextQuestion() {
            if (currentIndex < quizData.length -1) {
                // If moving to the next question without answering, mark as skipped
                if (!quizData[currentIndex].isAnswered && !quizData[currentIndex].isSkipped) {
                    quizData[currentIndex].isSkipped = true;
                    // Optionally, save state back to Firestore after a skip
                    saveQuizToFirestore(document.getElementById("chapter").value.trim().toLowerCase().replace(/\s+/g, '-'), quizData);
                }
                currentIndex++;
                showQuestion();
            } else if (currentIndex === quizData.length -1) {
                submitQuiz();
            }
        }
        window.nextQuestion = nextQuestion;

        function previousQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                showQuestion();
            }
        }
        window.previousQuestion = previousQuestion;

        function skipQuestion() {
            if (currentIndex < quizData.length && !quizData[currentIndex].isAnswered) {
                quizData[currentIndex].isSkipped = true;
                quizData[currentIndex].userAnswerIndex = null;
                 // Optionally, save state back to Firestore after a skip
                saveQuizToFirestore(document.getElementById("chapter").value.trim().toLowerCase().replace(/\s+/g, '-'), quizData);
            }
            nextQuestion();
        }
        window.skipQuestion = skipQuestion;

        function submitQuiz() {
            clearInterval(countdownInterval);
            document.getElementById("quiz-container").classList.add("hidden");
            document.getElementById("quiz-results").classList.remove("hidden");
            
            let finalCorrect = 0, finalWrong = 0, finalSkipped = 0;
            quizData.forEach(q => {
                if (q.isAnswered) {
                    if (q.userAnswerIndex === q.correct) finalCorrect++;
                    else finalWrong++;
                } else {
                    finalSkipped++;
                }
            });
            
            document.getElementById("total-questions-result").innerText = quizData.length;
            document.getElementById("correct-answers-result").innerText = finalCorrect;
            document.getElementById("wrong-answers-result").innerText = finalWrong;
            document.getElementById("skipped-questions-result").innerText = finalSkipped;
            document.getElementById("final-score-result").innerText = finalCorrect;
            document.getElementById("max-score-result").innerText = quizData.length;

            // Final save of the completed quiz state
            saveQuizToFirestore(document.getElementById("chapter").value.trim().toLowerCase().replace(/\s+/g, '-'), quizData);
        }
        window.submitQuiz = submitQuiz;

    </script>
</body>
</html>
