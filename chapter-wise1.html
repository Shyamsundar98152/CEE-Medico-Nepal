<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CEE Medico Chapter Backup System</title>
    <style>
        /* Define the CEE Medico color palette and font */
        :root {
            --primary-blue: #003366; /* Deep Blue */
            --secondary-blue: #004488;
            --light-bg: #f1f5f9;
            --text-dark: #1f2937;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: var(--light-bg);
            line-height: 1.6;
            color: var(--text-dark);
        }
        /* Custom Header Styling for CEE Medico Look */
        header {
            background-color: var(--primary-blue);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header-title { margin: 0; font-size: 2.25em; font-weight: 700; }
        nav { display: flex; justify-content: center; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
        nav a { color: white; text-decoration: none; font-weight: 600; padding: 8px 15px; border-radius: 6px; transition: background-color 0.3s ease; }
        nav a:hover { background-color: var(--secondary-blue); }
        main {
            max-width: 900px;
            margin: 25px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-title { font-size: 1.8em; }
            main { margin: 15px; padding: 20px; }
            nav { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-title">CEE Medico Nepal</div>
        <nav>
            <a href="#">Home</a>
            <a href="#">About</a>
            <a href="#">Premium</a>
            <a href="#">Login</a>
        </nav>
    </header>

    <main>
        <div id="auth-status" class="text-xs text-right text-gray-500 mb-4">
            Initializing secure session...
        </div>

        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6 border-b-2 border-blue-600 pb-2">
            üìö Secure Chapter Backup & Notes
        </h2>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <input type="text" id="chapterInput" placeholder="Enter Chapter Name (e.g., Human Anatomy)"
                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" />
            <button onclick="handleChapter()" id="action-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 w-full md:w-auto">
                Generate/Load Chapter
            </button>
        </div>

        <!-- Custom Modal/Message Box (Replaces alert()) -->
        <div id="message-box" class="hidden p-4 rounded-lg font-medium text-center shadow-md mb-4" role="alert"></div>

        <div id="output" class="min-h-[200px] mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-wrap leading-relaxed shadow-inner">
            <p class="text-gray-500 italic">Enter a chapter name above to load existing notes or generate new AI content.</p>
        </div>

    </main>

    <footer class="text-center p-4 text-sm text-gray-600 border-t mt-8">
        <p>&copy; 2025 CEE Medico Nepal. All rights reserved. | <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a></p>
    </footer>

    <script type="module">
        // Standard Firebase Imports (using CDN paths for modular use in a single HTML file)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- MANDATORY CANVAS GLOBAL VARIABLE INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, storage, userId = null;

        /**
         * Utility to display non-blocking messages (replacing alert()).
         * @param {string} message - The message content.
         * @param {string} type - 'error', 'success', or 'info'.
         */
        function displayMessage(message, type = 'info') {
            const box = document.getElementById("message-box");
            box.innerText = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');

            switch (type) {
                case 'error':
                    box.classList.add('bg-red-100', 'text-red-700');
                    break;
                case 'success':
                    box.classList.add('bg-green-100', 'text-green-700');
                    break;
                default: // info
                    box.classList.add('bg-blue-100', 'text-blue-700');
            }
            setTimeout(() => box.classList.add('hidden'), 5000);
        }

        /**
         * Initializes Firebase and authenticates the user using the provided token or anonymously.
         */
        async function initializeFirebase() {
            const authStatus = document.getElementById("auth-status");
            authStatus.innerText = "Connecting to Firebase...";

            if (!firebaseConfig) {
                authStatus.innerText = "Error: Firebase configuration missing.";
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                authStatus.innerText = "Authenticating user...";

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if no custom token is available
                    await signInAnonymously(auth);
                }

                // Listener to capture the authenticated user ID (UID)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.innerHTML = `‚úÖ Session ready. User ID: <span class="font-mono text-xs">${userId}</span>`;
                    } else {
                        userId = null;
                        authStatus.innerText = "Authentication failed or not ready.";
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatus.innerText = `üö® Firebase connection failed: ${error.message}`;
            }
        }
        
        window.onload = initializeFirebase;


        /**
         * Constructs the secure, private Firestore document reference path.
         * Path: /artifacts/{appId}/users/{userId}/chapters/{chapterName}
         */
        function getChapterDocRef(chapterName) {
            if (!userId || !db) {
                throw new Error("Application not fully initialized or user not authenticated.");
            }
            // Use the secure private path structure
            const securePath = `artifacts/${appId}/users/${userId}/chapters`;
            return doc(db, securePath, chapterName);
        }


        // AI Generator (Hugging Face Free Model)
        async function generateAIContent(chapterName) {
            // NOTE: The Authorization token below is a placeholder and should be replaced 
            // with a valid, secure token in a production environment.
            const HF_TOKEN = "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"; 

            try {
                const response = await fetch("https://api-inference.huggingface.co/models/gpt2", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${HF_TOKEN}`, 
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ inputs: `Write detailed study notes for the CEE Medico Nepal chapter: ${chapterName}.` })
                });

                if (!response.ok) {
                    throw new Error(`Hugging Face API failed with status: ${response.status}`);
                }

                const data = await response.json();
                return data[0]?.generated_text || "‚ö†Ô∏è AI failed to generate content.";

            } catch (error) {
                console.error("AI Generation Error:", error);
                displayMessage(`AI generation failed: ${error.message}`, 'error');
                return "‚ö†Ô∏è AI content generation failed.";
            }
        }


        // Handle Chapter Load/Generate
        async function handleChapter() {
            const chapterInput = document.getElementById("chapterInput");
            const chapterName = chapterInput.value.trim();
            const output = document.getElementById("output");
            const actionButton = document.getElementById("action-button");
            
            if (!chapterName) {
                displayMessage("Please enter a chapter name.", 'error');
                return;
            }
            if (!userId) {
                displayMessage("Authentication not ready. Please wait a moment.", 'error');
                return;
            }

            output.innerHTML = `<p class="text-blue-500 italic">‚è≥ Checking Firebase for ${chapterName}...</p>`;
            actionButton.disabled = true;

            const chapterId = chapterName.toLowerCase().replace(/[^a-z0-9]+/g, '-');

            try {
                const docRef = getChapterDocRef(chapterId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    // Load from Firestore
                    const content = docSnap.data().content || 'No content found.';
                    output.innerHTML = `<p class="text-green-600 font-semibold">üìÇ Loaded from Secure Backup:</p><br>` + content;
                    displayMessage(`Loaded chapter notes for "${chapterName}".`, 'success');
                } else {
                    // Generate new AI content
                    output.innerHTML = `<p class="text-yellow-600 font-semibold">ü§ñ Generating new content for ${chapterName}...</p>`;
                    
                    const aiText = await generateAIContent(chapterName);

                    if (aiText.includes("‚ö†Ô∏è AI content generation failed.")) {
                        output.innerHTML = `<p class="text-red-600">${aiText}</p>`;
                        return;
                    }

                    // 1. Save to Firestore (Primary private storage)
                    await setDoc(docRef, { 
                        chapter: chapterName,
                        content: aiText, 
                        timestamp: Date.now(),
                        userId: userId 
                    });

                    // 2. Backup to Storage as JSON (Secondary backup - useful for large content)
                    const backupRef = ref(storage, `artifacts/${appId}/users/${userId}/backups/${chapterId}.json`);
                    await uploadString(backupRef, JSON.stringify({ chapter: chapterName, content: aiText }), 'raw');

                    output.innerHTML = `<p class="text-green-600 font-semibold">‚úÖ Generated & Secured:</p><br>` + aiText;
                    displayMessage(`Notes generated and saved securely to Firestore and Storage for "${chapterName}".`, 'success');
                }
            } catch (error) {
                console.error("Chapter processing error:", error);
                output.innerHTML = `<p class="text-red-600">üö® An error occurred: ${error.message}. Check console for details.</p>`;
                displayMessage(`Operation failed: ${error.message}`, 'error');
            } finally {
                actionButton.disabled = false;
            }
        }
        window.handleChapter = handleChapter;
    </script>
</body>
</html>
