<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CEE Medico Chapter Backup System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin:0; color:#1f2937; }
        header { background:#003366; color:white; padding:15px 20px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
        .header-title { font-size:2.25em; font-weight:700; margin:0;}
        nav { display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-top:10px;}
        nav a { color:white; text-decoration:none; font-weight:600; padding:8px 15px; border-radius:6px; transition:0.3s;}
        nav a:hover { background:#004488;}
        main { max-width:900px; margin:25px auto; background:white; padding:30px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.1);}
        #output { min-height:200px; padding:20px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; white-space:pre-wrap; }
        #message-box { display:none; padding:12px; border-radius:8px; text-align:center; margin-bottom:10px; }
    </style>
</head>
<body>
    <header>
        <div class="header-title">CEE Medico Nepal</div>
        <nav>
            <a href="#">Home</a>
            <a href="#">About</a>
            <a href="#">Premium</a>
            <a href="#">Login</a>
        </nav>
    </header>

    <main>
        <div id="message-box"></div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <input type="text" id="chapterInput" placeholder="Enter Chapter Name (e.g., Human Anatomy)"
                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"/>
            <button onclick="handleChapter()" id="action-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md w-full md:w-auto">
                Generate/Load Chapter
            </button>
        </div>

        <div id="output">
            <p class="text-gray-500 italic">Enter a chapter name above to load existing notes or generate new AI content.</p>
        </div>
    </main>

    <footer class="text-center p-4 text-sm text-gray-600 border-t mt-8">
        &copy; 2025 CEE Medico Nepal
    </footer>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyDD5xBrSkX_YXzSnsKxjW8-K6W4rBfV3rg",
          authDomain: "chapter-wise-backup.firebaseapp.com",
          projectId: "chapter-wise-backup",
          storageBucket: "chapter-wise-backup.firebasestorage.app",
          messagingSenderId: "864698641587",
          appId: "1:864698641587:web:d0b550579c6eb7709ed4c6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Utility function for messages
        function displayMessage(msg, type='info') {
            const box = document.getElementById("message-box");
            box.innerText = msg;
            box.style.display = "block";
            box.style.background = type==='error' ? '#fee2e2' : type==='success' ? '#dcfce7' : '#bfdbfe';
            box.style.color = type==='error' ? '#b91c1c' : type==='success' ? '#166534' : '#1e3a8a';
            setTimeout(()=>box.style.display="none", 5000);
        }

        // Firestore doc ref
        function getChapterDocRef(chapterName) {
            const chapterId = chapterName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            return doc(db, "chapters", chapterId);
        }

        // Hugging Face AI Content Generator
        async function generateAIContent(chapterName) {
            const HF_TOKEN = "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";
            try {
                const response = await fetch("https://api-inference.huggingface.co/models/gpt2", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${HF_TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ inputs: `Write detailed study notes for the CEE Medico Nepal chapter: ${chapterName}.` })
                });
                if(!response.ok) throw new Error(`HF API failed: ${response.status}`);
                const data = await response.json();
                return data[0]?.generated_text || "AI failed to generate content.";
            } catch(e) {
                displayMessage("AI generation failed: "+e.message,'error');
                return "‚ö†Ô∏è AI generation failed.";
            }
        }

        async function handleChapter() {
            const chapterInput = document.getElementById("chapterInput");
            const output = document.getElementById("output");
            const chapterName = chapterInput.value.trim();
            const actionButton = document.getElementById("action-button");

            if(!chapterName) { displayMessage("Please enter chapter name.",'error'); return; }

            output.innerHTML = `<p class="text-blue-500 italic">‚è≥ Checking Firebase for ${chapterName}...</p>`;
            actionButton.disabled = true;

            const docRef = getChapterDocRef(chapterName);

            try {
                const docSnap = await getDoc(docRef);
                if(docSnap.exists()) {
                    const content = docSnap.data().content || "No content found.";
                    output.innerHTML = `<p class="text-green-600 font-semibold">üìÇ Loaded from backup:</p><br>` + content;
                    displayMessage(`Loaded chapter "${chapterName}" from Firebase.`,'success');
                } else {
                    output.innerHTML = `<p class="text-yellow-600 font-semibold">ü§ñ Generating new content for ${chapterName}...</p>`;
                    const aiText = await generateAIContent(chapterName);

                    // Save to Firestore
                    await setDoc(docRef, { chapter: chapterName, content: aiText, timestamp: Date.now() });

                    // Backup to Storage
                    const backupRef = ref(storage, `backups/${chapterName.toLowerCase().replace(/[^a-z0-9]+/g,'-')}.json`);
                    await uploadString(backupRef, JSON.stringify({ chapter: chapterName, content: aiText }), 'raw');

                    output.innerHTML = `<p class="text-green-600 font-semibold">‚úÖ Generated & backed up:</p><br>` + aiText;
                    displayMessage(`Generated and backed up "${chapterName}" successfully.`,'success');
                }
            } catch(e) {
                output.innerHTML = `<p class="text-red-600">üö® Error: ${e.message}</p>`;
                displayMessage(`Operation failed: ${e.message}`,'error');
            } finally {
                actionButton.disabled = false;
            }
        }
        window.handleChapter = handleChapter;
    </script>
</body>
</html>
