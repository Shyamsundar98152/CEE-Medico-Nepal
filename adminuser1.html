<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - User Device Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-5xl">

        <!-- Login Section -->
        <div id="login-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg mt-16">
            <h1 class="text-2xl font-bold text-center mb-6">Admin Login</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                    <input type="email" id="email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@example.com">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Login</button>
            </form>
            <p id="login-error" class="text-red-500 text-center mt-4 text-sm"></p>
        </div>

        <!-- Admin Panel Section -->
        <div id="admin-panel" class="hidden">
            <header class="flex justify-between items-center bg-white p-4 rounded-lg shadow-md mb-8">
                <div>
                    <h1 class="text-2xl font-bold">Device Management</h1>
                    <p class="text-gray-600">Logged in as: <span id="admin-email" class="font-medium"></span></p>
                </div>
                <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
            </header>

            <div id="loading-indicator" class="text-center py-10">
                 <div class="spinner w-12 h-12 rounded-full border-4 border-gray-300 mx-auto"></div>
                 <p class="mt-4 text-gray-600">Loading user data...</p>
            </div>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Error: </strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <div id="user-list-container" class="space-y-6">
                <!-- User cards will be dynamically inserted here -->
            </div>
             <p id="no-users-message" class="hidden text-center text-gray-500 mt-10 text-lg">No users with devices found.</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            onValue, 
            remove 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB66MZa0WZk3WPydcjmCDu7P_CE0FD60ug",
            authDomain: "login-2f07b.firebaseapp.com",
            databaseURL: "https://login-2f07b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "login-2f07b",
            storageBucket: "login-2f07b.appspot.com",
            messagingSenderId: "709252763741",
            appId: "1:709252763741:web:b3902697cc9c8b157a7db4",
            measurementId: "G-G7ZY1MJ106"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // UI Elements
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const adminEmailSpan = document.getElementById('admin-email');
        const userListContainer = document.getElementById('user-list-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const noUsersMessage = document.getElementById('no-users-message');

        let usersUnsubscribe = null;
        let devicesUnsubscribe = null;

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in, check if they are an admin
                checkAdminStatus(user);
            } else {
                // User is signed out
                showLogin();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Login Error:", error);
                loginError.textContent = 'Invalid email or password.';
            }
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });
        
        function showLogin() {
            loginSection.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            if (usersUnsubscribe) usersUnsubscribe();
            if (devicesUnsubscribe) devicesUnsubscribe();
        }

        function showAdminPanel(user) {
            loginSection.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            adminEmailSpan.textContent = user.email;
        }
        
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // --- Admin & Data Logic ---
        function checkAdminStatus(user) {
            const adminRef = ref(db, 'admins/' + user.uid);
            onValue(adminRef, (snapshot) => {
                if (snapshot.exists() && snapshot.val() === true) {
                    // This is an admin
                    showAdminPanel(user);
                    loadAndDisplayData();
                } else {
                    // Not an admin, sign them out
                    alert('Access Denied. You are not an administrator.');
                    signOut(auth);
                }
            }, { onlyOnce: true }); // We only need to check once per login
        }
        
        function loadAndDisplayData() {
            loadingIndicator.classList.remove('hidden');
            noUsersMessage.classList.add('hidden');

            const usersRef = ref(db, 'users');
            const devicesRef = ref(db, 'userDevices');
            
            let usersData = {};
            let devicesData = {};

            // Detach previous listeners if they exist
            if (usersUnsubscribe) usersUnsubscribe();
            if (devicesUnsubscribe) devicesUnsubscribe();
            
            const render = () => {
                userListContainer.innerHTML = ''; // Clear previous content
                const uidsWithDevices = Object.keys(devicesData);
                
                if (uidsWithDevices.length === 0) {
                     noUsersMessage.classList.remove('hidden');
                     return;
                } else {
                     noUsersMessage.classList.add('hidden');
                }

                uidsWithDevices.forEach(uid => {
                    const user = usersData[uid] || { email: 'Unknown User' };
                    const devices = devicesData[uid];
                    const userCard = document.createElement('div');
                    userCard.className = 'bg-white p-6 rounded-lg shadow-md';
                    userCard.innerHTML = `
                        <div class="border-b pb-3 mb-4">
                            <h2 class="text-xl font-semibold">${user.email || 'No email provided'}</h2>
                            <p class="text-sm text-gray-500 font-mono">${uid}</p>
                        </div>
                        <div id="devices-${uid}" class="space-y-3">
                            <!-- Devices will be listed here -->
                        </div>
                    `;
                    userListContainer.appendChild(userCard);
                    const devicesContainer = userCard.querySelector(`#devices-${uid}`);

                    Object.entries(devices).forEach(([deviceId, deviceDetails]) => {
                        const deviceEl = document.createElement('div');
                        deviceEl.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-md border';
                        
                        const deviceInfo = document.createElement('div');
                        const deviceName = deviceDetails.name || deviceId; // Fallback to ID if name is not present
                        deviceInfo.innerHTML = `<p class="font-medium text-gray-800">${deviceName}</p><p class="text-xs text-gray-500 font-mono">${deviceId}</p>`;
                        
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.className = 'bg-red-100 text-red-700 text-sm font-semibold py-1 px-3 rounded-md hover:bg-red-200 transition';
                        deleteButton.onclick = () => handleDeleteDevice(uid, deviceId, deviceName);
                        
                        deviceEl.appendChild(deviceInfo);
                        deviceEl.appendChild(deleteButton);
                        devicesContainer.appendChild(deviceEl);
                    });
                });
            };

            usersUnsubscribe = onValue(usersRef, (snapshot) => {
                usersData = snapshot.val() || {};
                if (Object.keys(devicesData).length > 0) render(); // Render if devices are already loaded
            }, (error) => {
                console.error("Error fetching users:", error);
                showError('Could not load user data. Check console for details.');
            });

            devicesUnsubscribe = onValue(devicesRef, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                devicesData = snapshot.val() || {};
                render();
            }, (error) => {
                console.error("Error fetching devices:", error);
                loadingIndicator.classList.add('hidden');
                showError('Could not load device data. Check console for details.');
            });
        }
        
        function handleDeleteDevice(uid, deviceId, deviceName) {
            const confirmation = confirm(`Are you sure you want to delete the device "${deviceName}" for user ${uid}?`);
            if(confirmation) {
                const deviceRef = ref(db, `userDevices/${uid}/${deviceId}`);
                remove(deviceRef)
                    .then(() => {
                        console.log(`Successfully deleted device ${deviceId} for user ${uid}`);
                    })
                    .catch((error) => {
                        console.error("Error deleting device:", error);
                        alert('Failed to delete device. You may not have permission.');
                    });
            }
        }
    </script>

</body>
</html>
