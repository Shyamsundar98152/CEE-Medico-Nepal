<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CeeMedico WhatsApp Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-image: url('https://cloud.githubusercontent.com/assets/398893/15136779/4e765036-1639-11e6-9201-67e728e86f39.jpg'); background-size: cover; }
    .chat-message { max-width: 70%; padding: 0.75rem 1.25rem; border-radius: 0.5rem; margin: 0.5rem 1rem; position: relative; }
    .self { background-color: #d9fdd3; color: black; margin-left: auto; border-bottom-right-radius: 0; }
    .other { background-color: #ffffff; color: black; margin-right: auto; border-bottom-left-radius: 0; }
    .loading-spinner { border: 4px solid rgba(0,0,0,0.3); border-radius: 50%; border-top: 4px solid #075e54; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .timestamp { font-size: 0.75rem; color: #666; margin-top: 0.25rem; }
    .status-ticks { font-size: 0.75rem; color: #4fc3f7; }
    .typing-indicator { font-size: 0.875rem; color: #666; background: #f0f0f0; padding: 0.5rem; border-radius: 0.5rem; }
    .msg-actions { opacity: 0; transition: opacity 0.2s; position: absolute; right: 0.5rem; top: 0.5rem; }
    .chat-message:hover .msg-actions { opacity: 1; }
    .edited { font-style: italic; font-size: 0.75rem; color: #666; margin-left: 0.5rem; }
    #load-more-btn { background: #075e54; color: white; }
    #error-message { color: #e53e3e; }
  </style>
</head>
<body class="bg-gray-100 text-black min-h-screen flex items-center justify-center p-4">
  <!-- Login Page -->
  <div id="login-page" class="w-full max-w-md">
    <div class="bg-white p-8 rounded-2xl shadow-2xl border border-gray-200">
      <h2 class="text-3xl font-extrabold mb-6 text-center text-green-600">CeeMedico Chat</h2>
      <button id="google-login-btn" class="w-full py-3 px-4 rounded-xl font-semibold bg-green-600 hover:bg-green-500 transition-colors flex items-center justify-center space-x-2">
        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="white" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L17 9.17c-.06.2-.1.41-.1.62 0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-1.5-2.25-1.5-2.25l-2.25 2.25zM6.5 9.75c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm5.5 3.5c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3z"/></svg>
        <span id="google-login-text">Sign in with Google</span>
        <div id="google-login-spinner" class="loading-spinner hidden"></div>
      </button>
      <p id="status" class="mt-6 text-center text-gray-600 text-sm"></p>
    </div>
  </div>

  <!-- Chat Page -->
  <div id="chat-page" class="hidden w-full max-w-5xl flex gap-6 h-[85vh]">
    <!-- Member List -->
    <div class="w-1/4 bg-white p-6 rounded-xl shadow-lg border border-gray-200 overflow-y-auto">
      <h2 class="text-xl font-bold mb-4 text-green-600">Online Members</h2>
      <ul id="member-list" class="space-y-3"></ul>
    </div>

    <!-- Chat Area -->
    <div class="w-3/4 flex flex-col bg-white p-6 rounded-xl shadow-lg border border-gray-200">
      <div id="error-message" class="text-center hidden mb-2"></div>
      <div id="messages" class="flex-1 overflow-y-auto mb-4 space-y-3 pr-2"></div>
      <button id="load-more-btn" class="hidden p-2 rounded-xl font-semibold mb-2">Load More Messages</button>
      <div id="typing-indicator" class="typing-indicator mb-2 hidden">Someone is typing...</div>
      <div class="flex gap-3">
        <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 p-3 rounded-3xl bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500"/>
        <button id="send-btn" class="bg-green-600 hover:bg-green-500 p-3 rounded-full font-semibold transition-colors">
          <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, push, update, query, orderByChild, limitToLast, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAvDLQZvlzJVeLaIAgntPiCit65DeeBgYQ",
      authDomain: "cee-medico-nepal-chat.firebaseapp.com",
      databaseURL: "https://cee-medico-nepal-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cee-medico-nepal-chat",
      storageBucket: "cee-medico-nepal-chat.appspot.com",
      messagingSenderId: "97605756433",
      appId: "1:97605756433:web:0fd8c595f6dfa18f00f3b0",
      measurementId: "G-QFJPC7489G"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM Elements
    const loginPage = document.getElementById("login-page");
    const chatPage = document.getElementById("chat-page");
    const googleLoginBtn = document.getElementById("google-login-btn");
    const googleLoginText = document.getElementById("google-login-text");
    const googleLoginSpinner = document.getElementById("google-login-spinner");
    const statusMessage = document.getElementById("status");
    const memberListEl = document.getElementById("member-list");
    const messagesEl = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const typingIndicator = document.getElementById("typing-indicator");
    const loadMoreBtn = document.getElementById("load-more-btn");
    const errorMessageEl = document.getElementById("error-message");

    let currentUser = null;
    let typingTimeout = null;
    let lastMessageKey = null;
    let lastMessageTimestamp = null;
    const messagesPerPage = 20;

    // Loading function
    function setLoading(isLoading) {
      googleLoginBtn.disabled = isLoading;
      googleLoginText.classList.toggle('hidden', isLoading);
      googleLoginSpinner.classList.toggle('hidden', !isLoading);
    }

    // Display error message
    function showError(message) {
      const errorText = message || 'An unknown error occurred';
      errorMessageEl.textContent = errorText;
      errorMessageEl.classList.remove('hidden');
      setTimeout(() => errorMessageEl.classList.add('hidden'), 5000);
      console.error('Error displayed:', errorText);
    }

    // Format timestamp
    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Unknown time';
      const date = new Date(timestamp);
      const today = new Date();
      const isToday = date.toDateString() === today.toDateString();
      return isToday
        ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : `${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    }

    // Google Sign-In
    googleLoginBtn.addEventListener('click', async () => {
      setLoading(true);
      statusMessage.textContent = "Signing in...";
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        currentUser = result.user;
        await set(ref(db, 'users/' + currentUser.uid), {
          name: currentUser.displayName || 'Unknown User',
          email: currentUser.email || '',
          photoURL: currentUser.photoURL || 'https://via.placeholder.com/32',
          lastActive: Date.now()
        });
        statusMessage.textContent = "Signed in successfully!";
      } catch (err) {
        const errorMsg = err.message || 'Authentication failed';
        showError(`Sign-in failed: ${errorMsg}`);
        console.error('Sign-in error:', err);
      } finally {
        setLoading(false);
      }
    });

    // Auth state change
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loginPage.classList.add('hidden');
        chatPage.classList.remove('hidden');
        loadMembers();
        loadMessages();
        updateUserStatus();
      } else {
        loginPage.classList.remove('hidden');
        chatPage.classList.add('hidden');
        memberListEl.innerHTML = '';
        messagesEl.innerHTML = '';
      }
    });

    // Update user status
    function updateUserStatus() {
      setInterval(() => {
        if (currentUser) {
          update(ref(db, 'users/' + currentUser.uid), { lastActive: Date.now() })
            .catch(err => {
              const errorMsg = err.message || 'Failed to update user status';
              showError(`Error updating user status: ${errorMsg}`);
              console.error('Error updating user status:', err);
            });
        }
      }, 30000);
    }

    // Load members
    function loadMembers() {
      const usersRef = ref(db, 'users/');
      onValue(usersRef, snapshot => {
        memberListEl.innerHTML = '';
        const users = snapshot.val();
        if (!users) {
          showError('No members found.');
          return;
        }
        for (const uid in users) {
          const user = users[uid];
          const isOnline = Date.now() - (user.lastActive || 0) < 60000;
          const li = document.createElement('li');
          li.className = `p-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center space-x-3 ${isOnline ? 'text-green-600' : 'text-gray-600'}`;
          li.innerHTML = `
            <img src="${user.photoURL || 'https://via.placeholder.com/32'}" class="w-10 h-10 rounded-full" alt="Avatar">
            <div>
              <span class="font-semibold">${user.name || 'Unknown User'}</span>
              <div class="text-sm ${isOnline ? 'text-green-500' : 'text-gray-400'}">${isOnline ? 'Online' : 'Offline'}</div>
            </div>`;
          memberListEl.appendChild(li);
        }
      }, err => {
        const errorMsg = err.message || 'Failed to load members';
        showError(`Failed to load members: ${errorMsg}`);
        console.error('Member load error:', err);
      });
    }

    // Typing indicator
    messageInput.addEventListener('input', () => {
      if (!currentUser) return;
      clearTimeout(typingTimeout);
      update(ref(db, 'typing/' + currentUser.uid), { isTyping: true })
        .catch(err => {
          const errorMsg = err.message || 'Failed to update typing status';
          showError(`Error updating typing status: ${errorMsg}`);
          console.error('Error updating typing status:', err);
        });
      typingTimeout = setTimeout(() => {
        update(ref(db, 'typing/' + currentUser.uid), { isTyping: false })
          .catch(err => {
            const errorMsg = err.message || 'Failed to clear typing status';
            showError(`Error clearing typing status: ${errorMsg}`);
            console.error('Error clearing typing status:', err);
          });
      }, 2000);
    });

    // Listen for typing users
    onValue(ref(db, 'typing/'), snapshot => {
      const typingData = snapshot.val() || {};
      let typingUsers = [];
      for (const uid in typingData) {
        if (typingData[uid].isTyping && uid !== currentUser?.uid) {
          typingUsers.push(uid);
        }
      }
      typingIndicator.classList.toggle('hidden', typingUsers.length === 0);
      typingIndicator.textContent = typingUsers.length > 0 ? `${typingUsers.length} user${typingUsers.length > 1 ? 's' : ''} typing...` : '';
    }, err => {
      const errorMsg = err.message || 'Failed to load typing status';
      showError(`Failed to load typing status: ${errorMsg}`);
      console.error('Typing indicator error:', err);
    });

    // Load messages with pagination
    function loadMessages() {
      const messagesRef = query(ref(db, 'messages/'), orderByChild('timestamp'), limitToLast(messagesPerPage));
      onValue(messagesRef, snapshot => {
        messagesEl.innerHTML = '';
        const messages = [];
        snapshot.forEach(child => {
          const msg = child.val();
          if (msg && msg.uid && msg.timestamp) {
            messages.push({ key: child.key, ...msg });
          }
        });
        if (messages.length === 0) {
          showError('No messages found.');
        } else {
          messages.reverse().forEach(msg => displayMessage(msg.key, msg));
          lastMessageKey = messages[messages.length - 1].key;
          lastMessageTimestamp = messages[messages.length - 1].timestamp;
          loadMoreBtn.classList.toggle('hidden', messages.length < messagesPerPage);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
      }, err => {
        const errorMsg = err.message || 'Failed to load messages';
        showError(`Failed to load messages: ${errorMsg}`);
        console.error('Message load error:', err);
      });

      // Real-time updates for new messages
      const realTimeRef = query(ref(db, 'messages/'), orderByChild('timestamp'));
      onValue(realTimeRef, snapshot => {
        snapshot.forEach(child => {
          const msg = child.val();
          if (!msg || !msg.uid || !msg.timestamp) return;
          const existingMsg = document.getElementById(child.key);
          if (existingMsg) {
            displayMessage(child.key, msg, true);
          } else if (msg.timestamp > (lastMessageTimestamp || 0)) {
            displayMessage(child.key, msg);
            lastMessageTimestamp = msg.timestamp;
            lastMessageKey = child.key;
            messagesEl.scrollTop = messagesEl.scrollHeight;
          }
        });
      }, err => {
        const errorMsg = err.message || 'Failed to listen for new messages';
        showError(`Failed to listen for new messages: ${errorMsg}`);
        console.error('Real-time message error:', err);
      });
    }

    // Load more messages
    loadMoreBtn.addEventListener('click', () => {
      if (!lastMessageKey || !lastMessageTimestamp) {
        showError('No more messages to load.');
        return;
      }
      const messagesRef = query(ref(db, 'messages/'), orderByChild('timestamp'), limitToLast(messagesPerPage), startAfter(lastMessageTimestamp));
      onValue(messagesRef, snapshot => {
        const messages = [];
        snapshot.forEach(child => {
          const msg = child.val();
          if (msg && msg.uid && msg.timestamp) {
            messages.push({ key: child.key, ...msg });
          }
        });
        if (messages.length === 0) {
          showError('No more messages to load.');
          loadMoreBtn.classList.add('hidden');
          return;
        }
        messages.reverse().forEach(msg => displayMessage(msg.key, msg, false, true));
        lastMessageKey = messages[messages.length - 1].key;
        lastMessageTimestamp = messages[messages.length - 1].timestamp;
        loadMoreBtn.classList.toggle('hidden', messages.length < messagesPerPage);
      }, { onlyOnce: true }, err => {
        const errorMsg = err.message || 'Failed to load more messages';
        showError(`Failed to load more messages: ${errorMsg}`);
        console.error('Load more error:', err);
      });
    });

    // Display message
    function displayMessage(id, msg, isUpdate = false, prepend = false) {
      if (!msg || !msg.uid) return;
      let msgEl = document.getElementById(id);
      const isSelf = msg.uid === currentUser?.uid;
      if (!msgEl) {
        msgEl = document.createElement('div');
        msgEl.id = id;
        msgEl.className = `chat-message ${isSelf ? 'self' : 'other'}`;
        prepend ? messagesEl.prepend(msgEl) : messagesEl.appendChild(msgEl);
      }
      const status = msg.read ? '✔✔' : msg.delivered ? '✔✔' : '✔';
      msgEl.innerHTML = `
        <div class="flex items-start">
          <div>
            <div class="flex items-center">
              <strong>${msg.name || 'Unknown User'}</strong>
              ${msg.edited ? '<span class="edited">(edited)</span>' : ''}
            </div>
            <span>${msg.deleted ? 'This message was unsent' : msg.text}</span>
            <div class="timestamp flex items-center">
              ${formatTimestamp(msg.timestamp)}
              ${isSelf && !msg.deleted ? `<span class="status-ticks ml-2">${status}</span>` : ''}
            </div>
          </div>
          ${isSelf && !msg.deleted ? `
            <div class="msg-actions flex space-x-2">
              <button onclick="editMessage('${id}')" class="text-yellow-600 hover:text-yellow-700">✏️</button>
              <button onclick="unsendMessage('${id}')" class="text-red-600 hover:text-red-700">🗑️</button>
            </div>` : ''}
        </div>`;
      if (isUpdate) {
        msgEl.querySelector('span').textContent = msg.deleted ? 'This message was unsent' : msg.text;
      }
      if (!prepend) messagesEl.scrollTop = messagesEl.scrollHeight;

      // Update message status to delivered/read
      if (!isSelf && !msg.read) {
        update(ref(db, 'messages/' + id), { delivered: true, read: true })
          .catch(err => {
            const errorMsg = err.message || 'Failed to update message status';
            showError(`Error updating message status: ${errorMsg}`);
            console.error('Error updating message status:', err);
          });
      }
    }

    // Send message
    sendBtn.addEventListener('click', () => {
      const text = messageInput.value.trim();
      if (!text) return;
      const newMsgRef = push(ref(db, 'messages/'));
      set(newMsgRef, {
        uid: currentUser.uid,
        name: currentUser.displayName || 'Unknown User',
        text: text,
        timestamp: Date.now(),
        edited: false,
        deleted: false,
        delivered: false,
        read: false
      }).then(() => {
        messageInput.value = '';
      }).catch(err => {
        const errorMsg = err.message || 'Failed to send message';
        showError(`Error sending message: ${errorMsg}`);
        console.error('Error sending message:', err);
      });
    });

    // Edit message
    window.editMessage = function(id) {
      const msgEl = document.getElementById(id);
      const currentText = msgEl.querySelector('span').textContent;
      if (currentText === 'This message was unsent') return;
      const newText = prompt("Edit message:", currentText);
      if (newText !== null && newText.trim()) {
        update(ref(db, 'messages/' + id), { text: newText.trim(), edited: true })
          .catch(err => {
            const errorMsg = err.message || 'Failed to edit message';
            showError(`Error editing message: ${errorMsg}`);
            console.error('Error editing message:', err);
          });
      }
    }

    // Unsend message
    window.unsendMessage = function(id) {
      if (confirm("Are you sure you want to unsend this message?")) {
        update(ref(db, 'messages/' + id), { deleted: true })
          .catch(err => {
            const errorMsg = err.message || 'Failed to unsend message';
            showError(`Error unsending message: ${errorMsg}`);
            console.error('Error unsending message:', err);
          });
      }
    }

    // Send message on Enter key
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        sendBtn.click();
      }
    });
  </script>
</body>
</html>
