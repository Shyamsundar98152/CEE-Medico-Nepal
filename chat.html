<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="apple-touch-icon" sizes="180x180" href="/fevicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/fevicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/fevicon/favicon-16x16.png">
    <link rel="manifest" href="/fevicon/site.webmanifest">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cee Medico Nepal Group Chat</title>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #1c1e21;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: #075e54;
            padding: 15px 0;
            margin-top: 0;
            font-size: 2.5em;
            text-align: center;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .auth-forms {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-forms h2 {
            color: #075e54;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
        }

        .auth-forms p {
            color: #555;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-forms input[type="text"],
        .auth-forms input[type="tel"] {
            width: calc(100% - 20px);
            padding: 12px 10px;
            margin-bottom: 15px;
            border: 1px solid #dcf8c6;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            box-sizing: border-box;
        }

        .auth-forms input:focus { border-color: #28a745; }

        .auth-forms button {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .auth-forms button:hover { background-color: #218838; }

        #chat-container {
            display: none;
            width: 100%;
            max-width: 600px;
            height: 75vh;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            flex-direction: column;
            overflow: hidden;
        }

        #chat-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #ece5dd;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.07);
        }

        .message.me {
            background-color: #dcf8c6;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.other {
            background-color: #ffffff;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .msg-header {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 6px;
            color: #075e54;
        }

        .msg-body { font-size: 1em; }

        .chat-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 8px;
            border: 1px solid #e0e0e0;
            display: block;
        }

        .msg-time {
            font-size: 0.7em;
            color: #888;
            margin-top: 6px;
            text-align: right;
            opacity: 0.7;
        }

        .msg-actions {
            margin-top: 8px;
            text-align: right;
            font-size: 0.8em;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
        }

        .msg-actions button {
            background: none;
            border: none;
            color: #075e54;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .msg-actions button:hover { background-color: #e0f2f7; }

        #typing-indicator {
            font-style: italic;
            font-size: 0.9em;
            color: #888;
            padding: 8px 15px;
            height: 25px;
            text-align: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0s;
        }

        #typing-indicator.active {
            visibility: visible;
            opacity: 1;
        }

        #controls {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: #ffffff;
            width: 100%;
            max-width: 600px;
            margin: 10px auto;
            border-radius: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #message-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            background-color: #f0f2f5;
            margin-right: 10px;
        }

        #controls label {
            font-size: 1.5em;
            color: #075e54;
            cursor: pointer;
            margin-right: 10px;
            padding: 5px;
        }

        #controls label:hover { color: #28a745; }
        #file-input { display: none; }

        #send-button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
        }

        #send-button:hover { background-color: #218838; }

        #logout-button {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }

        #logout-button:hover { background-color: #c82333; }

        #recaptcha-container { margin-bottom: 15px; }

        @media (max-width: 600px) {
            h1 { font-size: 1.8em; }
            .auth-forms, #chat-container, #controls {
                width: 95%; margin: 15px auto;
            }
            #chat-container { height: 85vh; }
            .message { max-width: 85%; }
        }
    </style>
</head>
<body>
    <h1>ðŸ“¢ Group Chat</h1>

    <div id="auth-container" class="auth-forms">
        <form id="phoneAuthForm">
            <h2>Enter Your Phone Number</h2>
            <p>A verification code will be sent to this number.</p>
            <input id="nameInput" type="text" placeholder="Your Name" required>
            <input id="phoneInput" type="tel" placeholder="+1234567890" required>
            <div id="recaptcha-container"></div>
            <button id="sendCodeBtn" type="submit">Send Verification Code</button>
        </form>

        <form id="verifyCodeForm" style="display:none;">
            <h2>Verify Code</h2>
            <input id="codeInput" type="text" placeholder="Enter the code" required>
            <button id="verifyBtn" type="submit">Verify</button>
        </form>
    </div>

    <div id="chat-container">
        <button id="logout-button">Logout</button>
        <div id="chat-box"></div>
        <div id="typing-indicator">...</div>
        <div id="controls">
            <input id="message-input" type="text" placeholder="Type a message...">
            <label for="file-input">ðŸ“Ž</label>
            <input type="file" id="file-input" accept="image/*">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script type="module">
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAvDLQZvlzJVeLaIAgntPiCit65DeeBgYQ",
            authDomain: "cee-medico-nepal-chat.firebaseapp.com",
            databaseURL: "https://cee-medico-nepal-chat-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "cee-medico-nepal-chat",
            storageBucket: "cee-medico-nepal-chat.appspot.com",
            messagingSenderId: "97605756433",
            appId: "1:97605756433:web:0fd8c595f66dfa18f00f3b0"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPhoneNumber, onAuthStateChanged, signOut, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, query, limitToLast, get, set, onDisconnect, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        const phoneAuthForm = document.getElementById("phoneAuthForm");
        const verifyCodeForm = document.getElementById("verifyCodeForm");
        const authContainer = document.getElementById("auth-container");
        const chatContainer = document.getElementById("chat-container");
        const chatBox = document.getElementById("chat-box");
        const messageInput = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-button");
        const fileInput = document.getElementById("file-input");
        const typingIndicator = document.getElementById("typing-indicator");
        const logoutBtn = document.getElementById("logout-button");

        const phoneInput = document.getElementById("phoneInput");
        const nameInput = document.getElementById("nameInput");
        const codeInput = document.getElementById("codeInput");
        const sendCodeBtn = document.getElementById("sendCodeBtn");
        const verifyBtn = document.getElementById("verifyBtn");

        let currentUser = null;
        let verificationId = null;
        let recaptchaVerifier = null;
        let typingTimeout;

        // --- Authentication ---
        window.onload = function () {
            recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                'size': 'normal',
                'callback': (response) => {
                    // reCAPTCHA solved, allow signInWithPhoneNumber.
                },
                'expired-callback': () => {
                    alert('reCAPTCHA expired. Please try again.');
                }
            });
        };

        phoneAuthForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const phoneNumber = phoneInput.value.trim();
            if (!phoneNumber) return;
            try {
                const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
                window.confirmationResult = confirmationResult;
                verificationId = confirmationResult.verificationId;
                alert("Verification code sent!");
                phoneAuthForm.style.display = "none";
                verifyCodeForm.style.display = "block";
            } catch (err) {
                recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                alert("Failed to send code: " + err.message);
            }
        });

        verifyCodeForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const code = codeInput.value.trim();
            if (!code) return;
            try {
                const userCredential = await window.confirmationResult.confirm(code);
                const user = userCredential.user;
                const name = nameInput.value.trim() || user.phoneNumber;

                await set(ref(db, 'users/' + user.uid), {
                    name: name,
                    phoneNumber: user.phoneNumber,
                    uid: user.uid
                });

                alert("Login successful!");
                verifyCodeForm.reset();
            } catch (err) {
                alert("Verification failed: " + err.message);
            }
        });

        logoutBtn.addEventListener("click", async () => { await signOut(auth); });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authContainer.style.display = "none";
                chatContainer.style.display = "flex";
                setupTypingIndicator();
                loadChat();
            } else {
                currentUser = null;
                chatContainer.style.display = "none";
                authContainer.style.display = "flex";
                phoneAuthForm.style.display = "block";
                verifyCodeForm.style.display = "none";
                chatBox.innerHTML = "";
            }
        });

        // --- Chat realtime updates ---
        function loadChat() {
            chatBox.innerHTML = "";
            const chatRef = ref(db, 'chat');
            const chatQuery = query(chatRef, limitToLast(50));
            onChildAdded(chatQuery, (snap) => { renderMessage(snap.val(), snap.key); });
            onChildChanged(chatRef, (snap) => {
                const msgEl = document.getElementById("msg-" + snap.key);
                if (msgEl) msgEl.replaceWith(createMessageElement(snap.val(), snap.key));
            });
            onChildRemoved(chatRef, (snap) => {
                const msgEl = document.getElementById("msg-" + snap.key);
                if (msgEl) msgEl.remove();
            });
        }

        function createMessageElement(msg, msgId) {
            const div = document.createElement("div");
            div.id = "msg-" + msgId;
            div.classList.add("message");
            if (msg.uid === currentUser?.uid) {
                div.classList.add("me");
            } else {
                div.classList.add("other");
            }
            let content = `<div class="msg-header"><b>${msg.sender || "Unknown"}</b></div><div class="msg-body">`;
            if (msg.text) content += msg.text;
            if (msg.image) content += `<br><img src="${msg.image}" class="chat-img">`;
            content += `</div><div class="msg-time">${new Date(msg.time).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})}</div>`;
            if (msg.uid === currentUser?.uid) {
                content += `<div class="msg-actions">
                    <button class="edit-btn">Edit</button>
                    <button class="delete-all-btn">Unsend All</button>
                </div>`;
            }
            div.innerHTML = content;
            setupMessageActions(div, msgId, msg);
            return div;
        }

        function renderMessage(msg, msgId) {
            chatBox.appendChild(createMessageElement(msg, msgId));
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function setupMessageActions(messageElement, msgId, msgData) {
            messageElement.querySelector(".edit-btn")?.addEventListener("click", () => {
                const newText = prompt("Edit your message:", msgData.text || "");
                if (newText !== null && newText.trim() !== "") {
                    set(ref(db, 'chat/' + msgId), {
                        ...msgData,
                        text: newText.trim(),
                        edited: true,
                        time: msgData.time
                    });
                }
            });

            messageElement.querySelector(".delete-all-btn")?.addEventListener("click", () => {
                if (confirm("Delete this message for everyone?")) {
                    set(ref(db, 'chat/' + msgId), null);
                }
            });
        }

        // --- Sending messages ---
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });
        messageInput.addEventListener("input", () => {
            const typingRef = ref(db, `typing/${currentUser.uid}`);
            set(typingRef, { name: nameInput.value || currentUser.phoneNumber, typing: true });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(typingRef, { name: nameInput.value || currentUser.phoneNumber, typing: false });
            }, 2000);
        });

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && fileInput.files.length === 0) return;
            const userProfileRef = ref(db, 'users/' + currentUser.uid);
            get(userProfileRef).then(snapshot => {
                const name = snapshot.val()?.name || currentUser.phoneNumber;
                push(ref(db, 'chat'), { text, sender: name, uid: currentUser.uid, time: Date.now() });
            });
            messageInput.value = "";
            clearTimeout(typingTimeout);
            set(ref(db, `typing/${currentUser.uid}`), { name: nameInput.value || currentUser.phoneNumber, typing: false });
        }

        // --- Image upload ---
        fileInput.addEventListener("change", (e) => {
            if (!currentUser) return alert("Please log in first.");
            const file = e.target.files[0];
            if (!file) return;
            const storageRef = sRef(storage, `chatImages/${currentUser.uid}/${Date.now()}_${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);
            uploadTask.on('state_changed', null, (err) => alert("Upload failed: " + err.message),
                () => getDownloadURL(uploadTask.snapshot.ref).then(url => {
                    get(ref(db, 'users/' + currentUser.uid)).then(snapshot => {
                        const name = snapshot.val()?.name || currentUser.phoneNumber;
                        push(ref(db, 'chat'), { image: url, sender: name, uid: currentUser.uid, time: Date.now() });
                    });
                })
            );
        });

        // --- Typing indicator logic ---
        function setupTypingIndicator() {
            const typingRef = ref(db, 'typing');
            onValue(typingRef, (snapshot) => {
                const typers = snapshot.val() || {};
                const typingUsers = Object.keys(typers)
                    .filter(uid => typers[uid].typing && uid !== currentUser.uid)
                    .map(uid => typers[uid].name);

                if (typingUsers.length > 0) {
                    typingIndicator.classList.add('active');
                    let typersText = typingUsers.length === 1 ?
                        `${typingUsers[0]} is typing...` :
                        `${typingUsers.slice(0, 2).join(', ')} and ${typingUsers.length - 2} others are typing...`;
                    if (typingUsers.length === 2) {
                         typersText = `${typingUsers[0]} and ${typingUsers[1]} are typing...`;
                    }
                    typingIndicator.textContent = typersText;
                } else {
                    typingIndicator.classList.remove('active');
                }
            });

            onDisconnect(ref(db, `typing/${currentUser.uid}`)).set({
                name: nameInput.value || currentUser.phoneNumber,
                typing: false
            });
        }
    </script>
</body>
</html>
