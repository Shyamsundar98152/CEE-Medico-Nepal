<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CeeMedico Group Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .chat-message { 
      max-width: 70%; padding: 0.5rem 1rem; border-radius: 1rem; margin: 0.2rem 0; 
      word-wrap: break-word; 
    }
    .self { background-color: #2563eb; color: white; margin-left: auto; }
    .other { background-color: #374151; color: white; margin-right: auto; }
    .loading-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 1rem;
      height: 1rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #1f2937; padding: 2rem; border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 90%; max-width: 400px;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

<!-- Login Page -->
<div id="login-page" class="w-full max-w-sm">
  <div class="bg-gray-800 p-8 rounded-2xl shadow-xl">
    <h2 class="text-3xl font-bold mb-6 text-center text-teal-300">👋 Welcome!</h2>
    <button id="google-login-btn" class="w-full py-3 px-4 rounded-xl font-semibold bg-gray-700 hover:bg-gray-600 flex items-center justify-center space-x-2 transition transform hover:scale-105">
      <span id="google-login-text">Sign in with Google</span>
      <div id="google-login-spinner" class="loading-spinner hidden"></div>
    </button>
    <p id="status" class="mt-6 text-center text-gray-400 text-sm"></p>
  </div>
</div>

<!-- Chat Page -->
<div id="chat-page" class="hidden w-full max-w-4xl flex flex-col md:flex-row gap-4">
  <!-- Member List -->
  <div class="w-full md:w-1/4 bg-gray-800 p-4 rounded-xl overflow-y-auto h-[80vh]">
    <h2 class="text-lg font-bold mb-4">Members</h2>
    <ul id="member-list" class="space-y-2"></ul>
  </div>

  <!-- Chat Area -->
  <div class="w-full md:w-3/4 flex flex-col bg-gray-800 p-4 rounded-xl h-[80vh]">
    <div id="user-info" class="flex items-center gap-4 mb-4 pb-4 border-b border-gray-700">
      <img id="user-avatar" class="w-10 h-10 rounded-full" alt="User Avatar"/>
      <span id="user-name" class="font-semibold text-lg"></span>
    </div>
    <div id="messages" class="flex-1 overflow-y-auto mb-4 space-y-2"></div>
    <div class="flex gap-2">
      <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 p-3 rounded-xl bg-gray-700 text-white border-none focus:outline-none"/>
      <button id="send-btn" class="bg-blue-600 p-3 rounded-xl hover:bg-blue-700 transition transform hover:scale-105">Send</button>
    </div>
  </div>
</div>

<!-- Custom Modal UI for Editing/Confirming -->
<div id="action-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
    <input id="modal-input" type="text" class="w-full p-3 rounded-xl bg-gray-700 text-white mb-4 hidden"/>
    <p id="modal-text" class="mb-4 text-gray-400 hidden"></p>
    <div class="flex justify-end gap-2">
      <button id="modal-cancel-btn" class="bg-gray-600 text-white py-2 px-4 rounded-xl hover:bg-gray-700 transition">Cancel</button>
      <button id="modal-confirm-btn" class="bg-blue-600 text-white py-2 px-4 rounded-xl hover:bg-blue-700 transition"></button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, onSnapshot, setDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Global variables from the environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(__firebase_config);
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM elements
  const loginPage = document.getElementById("login-page");
  const chatPage = document.getElementById("chat-page");
  const googleLoginBtn = document.getElementById("google-login-btn");
  const googleLoginText = document.getElementById("google-login-text");
  const googleLoginSpinner = document.getElementById("google-login-spinner");
  const statusMessage = document.getElementById("status");
  const memberListEl = document.getElementById("member-list");
  const messagesEl = document.getElementById("messages");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const userAvatarEl = document.getElementById("user-avatar");
  const userNameEl = document.getElementById("user-name");

  // Modal DOM elements
  const actionModal = document.getElementById("action-modal");
  const modalTitle = document.getElementById("modal-title");
  const modalInput = document.getElementById("modal-input");
  const modalText = document.getElementById("modal-text");
  const modalCancelBtn = document = document.getElementById("modal-cancel-btn");
  const modalConfirmBtn = document.getElementById("modal-confirm-btn");

  let currentUser = null;
  let isAuthReady = false;

  // --- Utility Functions ---

  function setLoading(isLoading) {
    googleLoginBtn.disabled = isLoading;
    googleLoginText.classList.toggle('hidden', isLoading);
    googleLoginSpinner.classList.toggle('hidden', !isLoading);
  }

  // --- Authentication ---

  // Handle Firebase auth using the provided custom token
  if (initialAuthToken) {
    signInWithCustomToken(auth, initialAuthToken).catch((error) => {
      console.error("Error signing in with custom token:", error);
      signInAnonymously(auth); // Fallback to anonymous if custom token fails
    });
  } else {
    signInAnonymously(auth);
  }

  // Handle Google Sign-In for an existing authenticated user
  googleLoginBtn.addEventListener('click', async () => {
    setLoading(true);
    statusMessage.textContent = "Signing in with Google...";
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (err) {
      statusMessage.textContent = `Error: ${err.message}`;
    } finally {
      setLoading(false);
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      isAuthReady = true;
      loginPage.classList.add('hidden');
      chatPage.classList.remove('hidden');
      userNameEl.textContent = currentUser.displayName || 'Anonymous User';
      userAvatarEl.src = currentUser.photoURL || `https://placehold.co/40x40/4b5563/ffffff?text=${(currentUser.displayName || 'A').charAt(0)}`;
      
      const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid);
      await setDoc(userDocRef, {
        name: currentUser.displayName || 'Anonymous',
        photoURL: currentUser.photoURL || null,
        lastActive: serverTimestamp()
      }, { merge: true });

      // Load initial members and messages
      loadMembers();
      loadMessages();
    } else {
      currentUser = null;
      isAuthReady = true;
      loginPage.classList.remove('hidden');
      chatPage.classList.add('hidden');
    }
  });

  // --- Firestore Functions ---

  // Load members from Firestore
  function loadMembers() {
    if (!isAuthReady || !currentUser) return;
    const usersCollectionRef = collection(db, 'artifacts', appId, 'users');
    onSnapshot(usersCollectionRef, (snapshot) => {
      memberListEl.innerHTML = '';
      snapshot.docs.forEach(doc => {
        const user = doc.data();
        const li = document.createElement('li');
        li.className = "p-2 rounded hover:bg-gray-700 cursor-pointer flex items-center gap-2 transition";
        li.innerHTML = `
          <div class="w-2 h-2 rounded-full bg-green-400"></div>
          <span>${user.name || 'Anonymous'}</span>
        `;
        memberListEl.appendChild(li);
      });
    });
  }

  // Load messages from Firestore in real-time
  function loadMessages() {
    if (!isAuthReady || !currentUser) return;
    const messagesCollectionRef = collection(db, 'artifacts', appId, 'public', 'messages');
    const q = query(messagesCollectionRef, orderBy('timestamp'));
    
    // Listen for real-time changes
    onSnapshot(q, (snapshot) => {
      messagesEl.innerHTML = ''; // Clear and re-render for simplicity
      snapshot.docs.forEach(doc => {
        const msg = doc.data();
        const id = doc.id;
        displayMessage(id, msg);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  // Display message
  function displayMessage(id, msg) {
    const msgEl = document.createElement('div');
    msgEl.id = id;
    msgEl.className = "chat-message " + (msg.uid === currentUser.uid ? 'self' : 'other');
    
    let content = `<strong>${msg.name || 'User'}:</strong> <span>${msg.text}</span>`;
    if (msg.deleted) {
      content = `<strong>${msg.name || 'User'}:</strong> <span>This message was unsent</span>`;
    }
    if (msg.edited && !msg.deleted) {
      content += `<span class="text-xs text-gray-400 italic"> (edited)</span>`;
    }

    let actions = '';
    if (msg.uid === currentUser.uid && !msg.deleted) {
      actions = `<div class="mt-1 space-x-2">
          <button onclick="editMessage('${id}')" class="text-yellow-300 hover:text-yellow-400 transition">✏️</button>
          <button onclick="unsendMessage('${id}')" class="text-red-400 hover:text-red-500 transition">🗑️</button>
        </div>`;
    }
    msgEl.innerHTML = `${content} ${actions}`;
    messagesEl.appendChild(msgEl);
  }

  // Send message
  const sendMessage = async () => {
    const text = messageInput.value.trim();
    if (!text || !currentUser) return;
    const messagesCollectionRef = collection(db, 'artifacts', appId, 'public', 'messages');
    await addDoc(messagesCollectionRef, {
      uid: currentUser.uid,
      name: currentUser.displayName,
      text: text,
      timestamp: serverTimestamp(),
      edited: false,
      deleted: false
    });
    messageInput.value = '';
  };

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  // Custom modal for editing message
  window.editMessage = function(id) {
    modalTitle.textContent = "Edit Message";
    modalText.classList.add('hidden');
    modalInput.classList.remove('hidden');
    modalInput.value = document.getElementById(id).querySelector('span').textContent;
    modalConfirmBtn.textContent = "Save";
    modalConfirmBtn.onclick = async () => {
      const newText = modalInput.value.trim();
      if (newText) {
        const msgDocRef = doc(db, 'artifacts', appId, 'public', 'messages', id);
        await updateDoc(msgDocRef, { text: newText, edited: true });
      }
      actionModal.classList.add('hidden');
    };
    modalCancelBtn.onclick = () => { actionModal.classList.add('hidden'); };
    actionModal.classList.remove('hidden');
  }

  // Custom modal for unsending message
  window.unsendMessage = function(id) {
    modalTitle.textContent = "Unsend Message";
    modalText.textContent = "Are you sure you want to unsend this message?";
    modalText.classList.remove('hidden');
    modalInput.classList.add('hidden');
    modalConfirmBtn.textContent = "Unsend";
    modalConfirmBtn.onclick = async () => {
      const msgDocRef = doc(db, 'artifacts', appId, 'public', 'messages', id);
      await updateDoc(msgDocRef, { deleted: true });
      actionModal.classList.add('hidden');
    };
    modalCancelBtn.onclick = () => { actionModal.classList.add('hidden'); };
    actionModal.classList.remove('hidden');
  }
</script>
</body>
</html>
