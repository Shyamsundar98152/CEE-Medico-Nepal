<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WhatsApp-Style Group Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, set, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAvDLQZvlzJVeLaIAgntPiCit65DeeBgYQ",
    authDomain: "cee-medico-nepal-chat.firebaseapp.com",
    databaseURL: "https://cee-medico-nepal-chat-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "cee-medico-nepal-chat",
    storageBucket: "cee-medico-nepal-chat.appspot.com",
    messagingSenderId: "97605756433",
    appId: "1:97605756433:web:0fd8c595f66dfa18f00f3b0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  let currentUser = null;
  let chatHistory = [];
  
  // DOM
  const signupForm = document.getElementById("signupForm");
  const loginForm = document.getElementById("loginForm");
  const chatBox = document.getElementById("chat");
  const messageInput = document.getElementById("message");
  const sendBtn = document.getElementById("send");
  const fileInput = document.getElementById("fileInput");
  const typingLabel = document.getElementById("typing");
  
  // Signup
  signupForm.onsubmit = async (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const password = document.getElementById("signupPassword").value;
    if (!name || !email || !password) return alert("Fill all fields");
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await set(ref(db, 'users/' + userCredential.user.uid), { name: name, email: email });
      alert("Signup successful! Please login below.");
      signupForm.reset();
      loginForm.style.display = "block";
    } catch (err) { alert(err.message); }
  };

  // Login
  loginForm.onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;
    if (!email || !password) return alert("Fill email & password");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch(err) { alert(err.message); }
  };

  // Auth state
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      signupForm.style.display = "none";
      loginForm.style.display = "none";
      chatBox.style.display = "block";
      loadChat();
    } else {
      currentUser = null;
      chatBox.style.display = "none";
      loginForm.style.display = "block";
    }
  });

  function loadChat(){
    chatBox.innerHTML = "";
    const chatQuery = query(ref(db, 'chat'), limitToLast(50));
    onChildAdded(chatQuery, (snap) => {
      const msg = snap.val();
      renderMessage(msg, snap.key);
      chatHistory.push(msg);
    });
  }

  function renderMessage(msg, msgId){
    const div = document.createElement("div");
    div.classList.add("message");
    if(currentUser && msg.uid === currentUser.uid){
      div.classList.add("me");
    } else { div.classList.add("other"); }

    let content = `<div class="msg-header"><b>${msg.sender}</b></div><div class="msg-body">`;
    if(msg.text) content += msg.text;
    if(msg.image) content += `<br><img src="${msg.image}" class="chat-img">`;
    content += `</div><div class="msg-time">${new Date(msg.time).toLocaleTimeString()}</div>`;

    if(currentUser && msg.uid === currentUser.uid){
      content += `<div class="msg-actions">
      <button class="edit-btn">Edit</button>
      <button class="delete-btn">Unsend</button>
      <button class="delete-all-btn">Unsend All</button>
      </div>`;
    }

    div.innerHTML = content;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;

    // Edit
    div.querySelector(".edit-btn")?.addEventListener("click", () => {
      const newText = prompt("Edit your message:", msg.text);
      if(newText){
        set(ref(db,'chat/'+msgId),{...msg, text:newText, edited:true});
      }
    });

    // Delete for me
    div.querySelector(".delete-btn")?.addEventListener("click", ()=>{
      div.remove();
    });

    // Delete for all
    div.querySelector(".delete-all-btn")?.addEventListener("click", ()=>{
      if(confirm("Delete for everyone?")) set(ref(db,'chat/'+msgId), null);
    });
  }

  // Send text
  sendBtn.onclick = () => {
    if(!messageInput.value.trim() || !currentUser) return;
    push(ref(db,'chat'),{
      text: messageInput.value,
      sender: currentUser.displayName || currentUser.email,
      uid: currentUser.uid,
      time: Date.now()
    });
    messageInput.value = "";
  };

  // Upload image
  fileInput.onchange = (e) => {
    if(!currentUser) return alert("Login required!");
    const file = e.target.files[0];
    if(!file || !file.type.match('image.*')) return alert("Select an image!");
    const storageRef = sRef(storage, "chatImages/"+Date.now()+"_"+file.name);
    const uploadTask = uploadBytesResumable(storageRef,file);
    uploadTask.on('state_changed', null, 
      err=>alert(err.message),
      ()=> getDownloadURL(uploadTask.snapshot.ref).then(url=>{
        push(ref(db,'chat'),{image:url,sender:currentUser.displayName||currentUser.email,uid:currentUser.uid,time:Date.now()});
      })
    );
    fileInput.value = "";
  };

  // Typing indicator
  let typingTimeout;
  messageInput.addEventListener("input", ()=>{
    if(currentUser){
      set(ref(db,"typing/"+currentUser.uid),currentUser.displayName+" is typing...");
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(()=>set(ref(db,"typing/"+currentUser.uid),null),2000);
    }
  });

  onChildAdded(ref(db,"typing"),snap=>{
    if(snap.val()) typingLabel.innerText = snap.val();
    setTimeout(()=>typingLabel.innerText="",2000);
  });
</script>

<style>
  body{font-family:Arial,sans-serif;margin:0;background:#e0f2f7}
  h2{text-align:center;color:#2196f3;padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  #signupForm,#loginForm{background:#bbdefb;padding:15px;border-radius:8px;margin:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  input{margin:5px;padding:10px;border-radius:24px;border:1px solid #90caf9;outline:none;width:200px}
  button{margin:5px;padding:10px 16px;border:none;border-radius:24px;background:#2196f3;color:#fff;cursor:pointer}
  button:hover{background:#1976d2}
  #chat{display:none;height:calc(100vh-250px);overflow-y:auto;padding:10px;background:#fff;border-radius:8px;margin:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  .message{margin:10px 5px;padding:8px 12px;border-radius:15px;max-width:75%;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
  .message.me{background:#90caf9;margin-left:auto}
  .message.other{background:#bbdefb;margin-right:auto}
  .msg-header{font-weight:bold;font-size:0.9em;margin-bottom:5px}
  .msg-body{margin-top:5px;word-wrap:break-word}
  .chat-img{max-width:100%;max-height:250px;border-radius:8px;margin-top:5px;border:1px solid #ddd}
  .msg-time{font-size:0.7em;color:#616161;text-align:right;margin-top:5px}
  .msg-actions{margin-top:5px;text-align:right}
  .msg-actions button{margin-left:5px;padding:5px 8px;border-radius:12px;font-size:0.7em}
  #controls{display:flex;padding:10px;background:#e3f2fd;border-radius:8px;margin:10px;align-items:center}
  #message{flex:1;padding:12px;border-radius:24px;border:1px solid #90caf9;outline:none;font-size:1em}
  #fileInput{display:none}
  #typing{font-style:italic;font-size:0.9em;color:#616161;height:20px;margin:0 10px}
</style>
</head>
<body>
<h2>ðŸ“¢ WhatsApp-Style Group Chat</h2>

<form id="signupForm">
  <input id="name" type="text" placeholder="Name" required>
  <input id="signupEmail" type="email" placeholder="Email" required>
  <input id="signupPassword" type="password" placeholder="Password" required>
  <button type="submit">Signup</button>
</form>

<form id="loginForm" style="display:none">
  <input id="loginEmail" type="email" placeholder="Email" required>
  <input id="loginPassword" type="password" placeholder="Password" required>
  <button type="submit">Login</button>
</form>

<div id="chat"></div>
<div id="typing"></div>

<div id="controls">
  <input id="message" type="text" placeholder="Type a message...">
  <label for="fileInput" style="cursor:pointer">ðŸ“Ž</label>
  <input type="file" id="fileInput" accept="image/*">
  <button id="send">Send</button>
</div>
</body>
</html>
