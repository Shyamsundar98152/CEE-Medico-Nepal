<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CeeMedico Group Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .chat-message { 
      max-width: 70%; padding: 0.5rem 1rem; border-radius: 1rem; margin: 0.2rem 0; 
      word-wrap: break-word; /* Ensure long words break */
    }
    .self { background-color: #2563eb; color: white; margin-left: auto; }
    .other { background-color: #374151; color: white; margin-right: auto; }
    .loading-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 1rem;
      height: 1rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #1f2937; padding: 2rem; border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 90%; max-width: 400px;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

<!-- Login Page -->
<div id="login-page" class="w-full max-w-sm">
  <div class="bg-gray-800 p-8 rounded-2xl shadow-xl">
    <h2 class="text-3xl font-bold mb-6 text-center text-teal-300">👋 Welcome!</h2>
    <button id="google-login-btn" class="w-full py-3 px-4 rounded-xl font-semibold bg-gray-700 hover:bg-gray-600 flex items-center justify-center space-x-2 transition transform hover:scale-105">
      <span id="google-login-text">Sign in with Google</span>
      <div id="google-login-spinner" class="loading-spinner hidden"></div>
    </button>
    <p id="status" class="mt-6 text-center text-gray-400 text-sm"></p>
  </div>
</div>

<!-- Chat Page -->
<div id="chat-page" class="hidden w-full max-w-4xl flex flex-col md:flex-row gap-4">
  <!-- Member List -->
  <div class="w-full md:w-1/4 bg-gray-800 p-4 rounded-xl overflow-y-auto h-[80vh]">
    <h2 class="text-lg font-bold mb-4">Members</h2>
    <ul id="member-list" class="space-y-2"></ul>
  </div>

  <!-- Chat Area -->
  <div class="w-full md:w-3/4 flex flex-col bg-gray-800 p-4 rounded-xl h-[80vh]">
    <div id="user-info" class="flex items-center gap-4 mb-4 pb-4 border-b border-gray-700">
      <img id="user-avatar" class="w-10 h-10 rounded-full" alt="User Avatar"/>
      <span id="user-name" class="font-semibold text-lg"></span>
    </div>
    <div id="messages" class="flex-1 overflow-y-auto mb-4 space-y-2"></div>
    <div class="flex gap-2">
      <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 p-3 rounded-xl bg-gray-700 text-white border-none focus:outline-none"/>
      <button id="send-btn" class="bg-blue-600 p-3 rounded-xl hover:bg-blue-700 transition transform hover:scale-105">Send</button>
    </div>
  </div>
</div>

<!-- Custom Modal UI for Editing/Confirming -->
<div id="action-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
    <input id="modal-input" type="text" class="w-full p-3 rounded-xl bg-gray-700 text-white mb-4 hidden"/>
    <p id="modal-text" class="mb-4 text-gray-400 hidden"></p>
    <div class="flex justify-end gap-2">
      <button id="modal-cancel-btn" class="bg-gray-600 text-white py-2 px-4 rounded-xl hover:bg-gray-700 transition">Cancel</button>
      <button id="modal-confirm-btn" class="bg-blue-600 text-white py-2 px-4 rounded-xl hover:bg-blue-700 transition"></button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getDatabase, ref, set, onChildAdded, onChildChanged, onDisconnect, onValue, push, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

  // Global variables from the environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(__firebase_config);
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // DOM
  const loginPage = document.getElementById("login-page");
  const chatPage = document.getElementById("chat-page");
  const googleLoginBtn = document.getElementById("google-login-btn");
  const googleLoginText = document.getElementById("google-login-text");
  const googleLoginSpinner = document.getElementById("google-login-spinner");
  const statusMessage = document.getElementById("status");
  const memberListEl = document.getElementById("member-list");
  const messagesEl = document.getElementById("messages");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const userAvatarEl = document.getElementById("user-avatar");
  const userNameEl = document.getElementById("user-name");

  // Modal DOM elements
  const actionModal = document.getElementById("action-modal");
  const modalTitle = document.getElementById("modal-title");
  const modalInput = document.getElementById("modal-input");
  const modalText = document.getElementById("modal-text");
  const modalCancelBtn = document.getElementById("modal-cancel-btn");
  const modalConfirmBtn = document.getElementById("modal-confirm-btn");

  let currentUser = null;

  // Loading function
  function setLoading(isLoading) {
    googleLoginBtn.disabled = isLoading;
    googleLoginText.classList.toggle('hidden', isLoading);
    googleLoginSpinner.classList.toggle('hidden', !isLoading);
  }

  // Google Sign-In
  googleLoginBtn.addEventListener('click', async () => {
    setLoading(true);
    statusMessage.textContent = "Signing in...";
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
      // Auth state change listener handles the rest
    } catch (err) {
      statusMessage.textContent = `Error: ${err.message}`;
    } finally {
      setLoading(false);
    }
  });

  // Auth state change
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      loginPage.classList.add('hidden');
      chatPage.classList.remove('hidden');

      // Set user info in the chat header
      userNameEl.textContent = currentUser.displayName;
      userAvatarEl.src = currentUser.photoURL || `https://placehold.co/40x40/4b5563/ffffff?text=${currentUser.displayName.charAt(0)}`;

      // Setup user presence and load data
      setupUserPresence();
      loadMembers();
      loadMessages();
    } else {
      currentUser = null;
      loginPage.classList.remove('hidden');
      chatPage.classList.add('hidden');
    }
  });

  // Setup user presence
  function setupUserPresence() {
    const userRef = ref(db, 'users/' + currentUser.uid);
    // Set user data including online status
    set(userRef, {
      name: currentUser.displayName,
      email: currentUser.email,
      photoURL: currentUser.photoURL,
      online: true,
    });
    // Set online status to false when the user disconnects
    onDisconnect(userRef).update({ online: false });
  }

  // Load members and listen for real-time changes
  function loadMembers() {
    const usersRef = ref(db, 'users/');
    onValue(usersRef, (snapshot) => {
      memberListEl.innerHTML = ''; // Clear the list
      snapshot.forEach(childSnapshot => {
        const user = childSnapshot.val();
        const li = document.createElement('li');
        li.className = "p-2 rounded hover:bg-gray-700 cursor-pointer flex items-center gap-2 transition";
        li.innerHTML = `
          <div class="w-2 h-2 rounded-full ${user.online ? 'bg-green-400' : 'bg-gray-500'}"></div>
          <span>${user.name}</span>
        `;
        memberListEl.appendChild(li);
      });
    });
  }

  // Load messages and listen for real-time changes
  function loadMessages() {
    const messagesRef = ref(db, 'messages/');
    onChildAdded(messagesRef, snapshot => {
      const msg = snapshot.val();
      displayMessage(snapshot.key, msg);
    });
    onChildChanged(messagesRef, snapshot => {
      const msg = snapshot.val();
      displayMessage(snapshot.key, msg, true);
    });
  }

  // Display message
  function displayMessage(id, msg, isUpdate = false) {
    let msgEl = document.getElementById(id);
    if (isUpdate) {
      if (msgEl) {
        msgEl.querySelector('span').textContent = msg.deleted ? 'This message was unsent' : msg.text;
        const editedTag = msgEl.querySelector('.edited-tag');
        if (msg.edited && !editedTag) {
            const span = document.createElement('span');
            span.textContent = ' (edited)';
            span.className = "text-xs text-gray-400 italic edited-tag";
            msgEl.appendChild(span);
        }
      }
    } else {
      msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = "chat-message " + (msg.uid === currentUser.uid ? 'self' : 'other');
      
      const content = `<strong>${msg.name || 'User'}:</strong> <span>${msg.deleted ? 'This message was unsent' : msg.text}</span>`;
      
      let actions = '';
      if (msg.uid === currentUser.uid && !msg.deleted) {
        actions = `<div class="mt-1 space-x-2">
            <button onclick="editMessage('${id}')" class="text-yellow-300 hover:text-yellow-400 transition">✏️</button>
            <button onclick="unsendMessage('${id}')" class="text-red-400 hover:text-red-500 transition">🗑️</button>
          </div>`;
      }
      msgEl.innerHTML = `${content} ${actions}`;
      messagesEl.appendChild(msgEl);
    }
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Send message
  const sendMessage = () => {
    const text = messageInput.value.trim();
    if (!text || !currentUser) return;
    const newMsgRef = push(ref(db, 'messages/'));
    set(newMsgRef, {
      uid: currentUser.uid,
      name: currentUser.displayName,
      text: text,
      timestamp: Date.now(),
      edited: false,
      deleted: false
    });
    messageInput.value = '';
  };

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  // Custom modal to replace prompt()
  window.editMessage = function(id) {
    modalTitle.textContent = "Edit Message";
    modalText.classList.add('hidden');
    modalInput.classList.remove('hidden');
    modalInput.value = document.getElementById(id).querySelector('span').textContent;
    modalConfirmBtn.textContent = "Save";

    modalConfirmBtn.onclick = () => {
      const newText = modalInput.value.trim();
      if (newText) {
        update(ref(db, 'messages/' + id), { text: newText, edited: true });
      }
      actionModal.classList.add('hidden');
    };

    modalCancelBtn.onclick = () => {
      actionModal.classList.add('hidden');
    };

    actionModal.classList.remove('hidden');
  }

  // Custom modal to replace confirm()
  window.unsendMessage = function(id) {
    modalTitle.textContent = "Unsend Message";
    modalText.textContent = "Are you sure you want to unsend this message?";
    modalText.classList.remove('hidden');
    modalInput.classList.add('hidden');
    modalConfirmBtn.textContent = "Unsend";

    modalConfirmBtn.onclick = () => {
      update(ref(db, 'messages/' + id), { deleted: true });
      actionModal.classList.add('hidden');
    };

    modalCancelBtn.onclick = () => {
      actionModal.classList.add('hidden');
    };

    actionModal.classList.remove('hidden');
  }
</script>
</body>
</html>
