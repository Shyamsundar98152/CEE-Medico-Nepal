<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Device Dashboard - ceemediconepal.xyz</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/fevicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/fevicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/fevicon/favicon-16x16.png">
    <link rel="manifest" href="/fevicon/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <style>
        /* Basic Reset & Font */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif; /* Changed font to Inter as per guidelines */
        }
        body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 80px; /* Space for fixed header */
            display: none; /* Hidden until authenticated and approved */
        }
        /* Header Styling */
        header {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }
        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover {
            color: #667eea;
        }
        #logoutBtn {
            padding: 8px 15px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px; /* Rounded corners */
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        #logoutBtn:hover {
            background: #cc0000;
        }
        /* Dashboard Container */
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; /* Rounded corners */
            padding: 30px;
            margin: 30px 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 20px;
        }
        /* User Info & Device List Sections */
        .user-info, .device-list, .admin-dashboard {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px; /* Rounded corners */
            border: 1px solid #eee;
        }
        .user-info h2, .device-list h2, .admin-dashboard h2 {
            color: #764ba2;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .user-info p {
            margin-bottom: 8px;
            font-size: 1.1em;
            color: #555;
        }
        .user-info span {
            font-weight: 600;
            color: #333;
        }
        /* Device Card Styling */
        .device-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px; /* Rounded corners */
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }
        .device-card:last-child {
            margin-bottom: 0;
        }
        .device-card p {
            margin: 0;
            font-size: 0.95em;
            color: #666;
        }
        .device-card strong {
            color: #333;
        }
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
        }
        .status-indicator.online {
            background-color: #28a745; /* Green */
        }
        .status-indicator.offline {
            background-color: #dc3545; /* Red */
        }
        .device-count {
            font-size: 1.2em;
            font-weight: bold;
            color: #764ba2;
            text-align: right;
            margin-top: 10px;
        }

        /* Admin Dashboard Specific Styles */
        .admin-dashboard {
            margin-top: 30px;
            display: none; /* Hidden by default, shown if admin */
        }
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .user-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .user-card h5 {
            color: #667eea;
            margin-bottom: 5px;
        }
        .user-card p {
            font-size: 0.9em;
            color: #555;
        }
        .user-card ul {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .user-card ul li {
            background: #f0f0f0;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.85em;
            word-break: break-all; /* Ensure long IDs wrap */
        }
        .user-card ul li:last-child {
            margin-bottom: 0;
        }
        .user-card .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
        .user-card .status-dot.online { background-color: #28a745; }
        .user-card .status-dot.offline { background-color: #dc3545; }


        /* Footer */
        footer {
            background: rgba(0, 0, 0, 0.2);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto; /* Pushes footer to bottom */
            width: 100%;
            border-radius: 8px 8px 0 0; /* Rounded top corners */
        }

        /* Message Box Styling */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s;
        }
        .message-box-overlay.show {
            visibility: visible;
            opacity: 1;
        }
        .message-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .message-box-overlay.show .message-box {
            transform: translateY(0);
        }
        .message-box h3 {
            margin-bottom: 20px;
            color: #333;
        }
        .message-box button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        .message-box button:hover {
            background: #5a6cdb;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 10px;
            }
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            .dashboard-container {
                padding: 20px;
                margin: 20px 10px;
            }
            .user-grid {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="https://ceemediconepal.xyz" class="logo">ceemediconepal.xyz</a>
            <div class="nav-links">
                <a href="https://ceemediconepal.xyz">Home</a>
                <a href="/secure/200-mcq-sets.html">Premium 200 MCQ Sets</a>
                <a href="/secure/mcq.html">Subject Wise Sets</a>
                <button id="logoutBtn">Logout</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <h1>Your Account & Devices</h1>

        <div class="user-info">
            <h2>User Information</h2>
            <p>Email: <span id="userEmail">Loading...</span></p>
            <p>Name: <span id="userName">Not available</span></p>
            <p>User ID: <span id="userId">Loading...</span></p>
        </div>

        <div class="device-list">
            <h2>Your Logged-In Devices</h2>
            <div id="devicesContainer">
                <p>Loading device data...</p>
            </div>
            <div class="device-count">
                Total Online Devices: <span id="onlineDeviceCount">0</span>
            </div>
        </div>

        <!-- Admin Dashboard Section -->
        <div id="adminDashboardSection" class="admin-dashboard">
            <h2>All Users & Devices (Admin View)</h2>
            <div id="userList" class="user-grid">
                <p>Loading all user data...</p>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 ceemediconepal.xyz - All Rights Reserved</p>
    </footer>

    <!-- Custom Message Box -->
    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box">
            <h3 id="messageBoxText"></h3>
            <button id="messageBoxCloseBtn">OK</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules for Firestore and Auth
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, getDoc, getDocs, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Import Realtime Database modules
        import { getDatabase, ref as rtdbRef, get as rtdbGet, onValue as rtdbOnValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";


        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app); // Initialize Realtime Database

        let currentUserId = null; // To store the authenticated user's UID
        let isAuthReady = false; // Flag to ensure Firebase operations run after auth is ready

        // --- Custom Message Box Functions ---
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxText = document.getElementById('messageBoxText');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        function showMessageBox(message) {
            messageBoxText.textContent = message;
            messageBoxOverlay.classList.add('show');
        }

        messageBoxCloseBtn.addEventListener('click', () => {
            messageBoxOverlay.classList.remove('show');
        });
        // --- End Custom Message Box Functions ---

        // Helper function to get the device ID (consistent with login page)
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                // Fallback: generate a new one if not found (should be set on login)
                deviceId = crypto.randomUUID(); // Use crypto.randomUUID for better uniqueness
                localStorage.setItem('deviceId', deviceId);
                console.warn("No deviceId found in localStorage. Generating a new one.");
            }
            return deviceId;
        }

        // Function to format Timestamps (handles both Firestore Timestamp objects and RTDB numbers)
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            let date;
            if (typeof timestamp.toDate === 'function') {
                // It's a Firestore Timestamp object
                date = timestamp.toDate();
            } else if (typeof timestamp === 'number') {
                // It's a Realtime Database timestamp (milliseconds since epoch)
                date = new Date(timestamp);
            } else {
                return 'N/A';
            }
            return date.toLocaleString(); // Formats to local date and time string
        }

        // Function to handle initial authentication
        async function handleInitialAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Initial authentication failed:", error);
                showMessageBox("Authentication required. Redirecting to login.");
                window.location.href = window.location.origin + "/secure/login.html"; // Use full path for robustness
            }
        }

        // Function to load all users for admin view (fetches devices from Realtime Database)
        async function loadAllUsers() {
            const userListContainer = document.getElementById("userList");
            const usersCollectionRef = collection(db, `artifacts/${appId}/users`); // Still using Firestore for user list

            onSnapshot(usersCollectionRef, async (snapshot) => {
                if (!isAuthReady) return; // Ensure auth is ready before processing snapshot
                userListContainer.innerHTML = ""; // Clear previous content

                if (snapshot.empty) {
                    userListContainer.innerHTML = "<p>No users found in the database.</p>";
                    return;
                }

                const userPromises = snapshot.docs.map(async (userDocSnap) => {
                    const uid = userDocSnap.id;
                    const userData = userDocSnap.data();
                    const email = userData.email || "N/A";
                    const displayName = userData.displayName || "Not available";
                    const isUserOnline = userData.isOnline || false; // This is from Firestore user doc
                    const isApproved = userData.isApproved || false;

                    let devicesHtml = "<ul><li>No devices.</li></ul>";
                    // Fetch devices from Realtime Database
                    try {
                        const userDevicesRTDBRef = rtdbRef(rtdb, `userDevices/${uid}`); // Realtime Database path
                        const devicesRTDBSnap = await rtdbGet(userDevicesRTDBRef); // Use rtdbGet for one-time fetch from RTDB

                        if (devicesRTDBSnap.exists()) {
                            devicesHtml = `<ul class="list-group">`;
                            const devices = devicesRTDBSnap.val(); // .val() for Realtime Database
                            for (const id in devices) {
                                const info = devices[id];
                                const deviceIsOnline = info.isOnline || false;
                                const statusDotClass = deviceIsOnline ? 'online' : 'offline';
                                devicesHtml += `
                                    <li class="list-group-item">
                                        <span class="status-dot ${statusDotClass}"></span>
                                        <strong>ID:</strong> ${id}<br/>
                                        <strong>Agent:</strong> ${info.userAgent || 'N/A'}<br/>
                                        <strong>Last Login:</strong> ${formatTimestamp(info.lastLogin)}<br/>
                                        <strong>Last Logout:</strong> ${formatTimestamp(info.lastLogout)}<br/>
                                        <strong>Status:</strong> <span style="color: ${deviceIsOnline ? '#28a745' : '#dc3545'}; font-weight: bold;">${deviceIsOnline ? 'Online' : 'Offline'}</span>
                                    </li>`;
                            }
                            devicesHtml += `</ul>`;
                        }
                    } catch (deviceError) {
                        console.error(`Error fetching devices for user ${uid} from RTDB:`, deviceError);
                        devicesHtml = "<ul><li>Error loading devices from Realtime Database.</li></ul>";
                    }

                    return `
                        <div class="user-card">
                            <h5>${email}</h5>
                            <p><strong>Name:</strong> ${displayName}</p>
                            <p><strong>UID:</strong> ${uid}</p>
                            <p><strong>Account Status:</strong> <span style="color: ${isApproved ? '#28a745' : '#dc3545'}; font-weight: bold;">${isApproved ? 'Approved' : 'Not Approved'}</span></p>
                            <p><strong>User Online Status:</strong> <span class="status-dot ${isUserOnline ? 'online' : 'offline'}"></span> <span style="color: ${isUserOnline ? '#28a745' : '#dc3545'}; font-weight: bold;">${isUserOnline ? 'Online' : 'Offline'}</span></p>
                            <p><strong>Devices:</strong></p>
                            ${devicesHtml}
                        </div>
                    `;
                });

                // Wait for all user cards to be generated and then append
                const userCardsHtml = await Promise.all(userPromises);
                userListContainer.innerHTML = userCardsHtml.join('');

            }, (error) => {
                console.error("Error listening to all users:", error);
                showMessageBox("Error loading all user data for admin view.");
            });
        }


        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("User authenticated:", user.uid);

                // Attempt to sign in with custom token if available, otherwise anonymously
                if (!isAuthReady) { // Only attempt initial auth if not already ready
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        console.log("Initial auth successful or already signed in.");
                    } catch (error) {
                        console.error("Error during initial sign-in:", error);
                        showMessageBox("Authentication failed. Please try logging in again.");
                        window.location.href = window.location.origin + "/secure/login.html";
                        return;
                    }
                }


                // Check user's approval status from Firestore
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
                try {
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists() && userDocSnap.data().isApproved === true) {
                        console.log("User is approved. Displaying dashboard.");
                        document.body.style.display = "flex";
                        isAuthReady = true;

                        // Display user information
                        document.getElementById('userEmail').textContent = user.email || 'N/A';
                        document.getElementById('userName').textContent = userDocSnap.data().displayName || user.displayName || 'Not available';
                        document.getElementById('userId').textContent = user.uid;

                        // Listen for current user's device data changes (from Firestore)
                        const userDevicesCollectionRef = collection(db, `artifacts/${appId}/users/${user.uid}/userDevices`);
                        onSnapshot(userDevicesCollectionRef, (snapshot) => {
                            if (!isAuthReady) return; // Ensure auth is ready before processing snapshot
                            console.log("Fetching current user's device data snapshot.");

                            const devicesContainer = document.getElementById('devicesContainer');
                            const onlineDeviceCountSpan = document.getElementById('onlineDeviceCount');
                            devicesContainer.innerHTML = ''; // Clear previous content
                            let onlineCount = 0;

                            if (!snapshot.empty) {
                                snapshot.forEach((docSnap) => {
                                    const deviceId = docSnap.id;
                                    const device = docSnap.data();
                                    const deviceCard = document.createElement('div');
                                    deviceCard.className = 'device-card';

                                    const isOnline = device.isOnline || false;
                                    if (isOnline) {
                                        onlineCount++;
                                    }

                                    deviceCard.innerHTML = `
                                        <span class="status-indicator ${isOnline ? 'online' : 'offline'}"></span>
                                        <p><strong>Device ID:</strong> ${deviceId}</p>
                                        <p><strong>User Agent:</strong> ${device.userAgent || 'N/A'}</p>
                                        <p><strong>Last Login:</strong> ${formatTimestamp(device.lastLogin)}</p>
                                        <p><strong>Last Logout:</strong> ${formatTimestamp(device.lastLogout)}</p>
                                        <p><strong>Status:</strong> <span style="color: ${isOnline ? '#28a745' : '#dc3545'}; font-weight: bold;">${isOnline ? 'Online' : 'Offline'}</span></p>
                                    `;
                                    devicesContainer.appendChild(deviceCard);
                                });
                            } else {
                                devicesContainer.innerHTML = '<p>No device data found for this user.</p>';
                            }
                            onlineDeviceCountSpan.textContent = onlineCount;
                        }, (error) => {
                            console.error("Error listening to current user devices:", error);
                            showMessageBox("Error loading your device data.");
                        });

                        // Check if the user is an admin
                        const adminDocRef = doc(db, `artifacts/${appId}/admins/${user.uid}`);
                        const adminDocSnap = await getDoc(adminDocRef);

                        if (adminDocSnap.exists() && adminDocSnap.data().isAdmin === true) {
                            console.log("User is an admin. Loading admin dashboard.");
                            document.getElementById('adminDashboardSection').style.display = 'block';
                            loadAllUsers(); // Load all users for the admin view
                        } else {
                            console.log("User is not an admin. Hiding admin dashboard.");
                            document.getElementById('adminDashboardSection').style.display = 'none';
                        }

                    } else {
                        // User is logged in but not approved or user document doesn't exist
                        console.warn("User not approved or document missing:", user.uid);
                        showMessageBox("‚õî Access Denied: Your account is not approved or does not exist. Please contact support.");
                        await signOut(auth); // Sign them out
                        window.location.href = window.location.origin + "/secure/login.html";
                    }
                } catch (error) {
                    console.error("Error fetching user approval status:", error);
                    showMessageBox("Error checking account status. Please try again.");
                    await signOut(auth);
                    window.location.href = window.location.origin + "/secure/login.html";
                }

            } else {
                // User is not signed in
                console.log("No user signed in. Redirecting to login.");
                // If auth was ready and now user is null, it means logout or session expired
                // Or if it's the very first load and no user, attempt initial auth
                if (!isAuthReady) {
                     handleInitialAuth();
                } else {
                    window.location.href = window.location.origin + "/secure/login.html";
                }
            }
        });

        // Logout functionality
        document.getElementById("logoutBtn").addEventListener("click", async () => {
            if (!currentUserId) {
                showMessageBox("No user is currently logged in.");
                return;
            }

            // Note: This part still updates Firestore for the *current user's* device status
            // because the main user dashboard uses Firestore for its own device tracking.
            const currentDeviceId = getDeviceId(); // Get the device ID for the current session
            const deviceDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/userDevices/${currentDeviceId}`);

            try {
                // Update the current device's status to offline and record logout time
                await updateDoc(deviceDocRef, {
                    lastLogout: serverTimestamp(),
                    isOnline: false
                });

                await signOut(auth); // Sign out from Firebase
                localStorage.removeItem('deviceId'); // Clear device ID from local storage
                showMessageBox("üëã Logged out successfully.");
                window.location.href = window.location.origin + "/secure/login.html";
            } catch (error) {
                console.error("Logout error:", error);
                showMessageBox("‚ùå Logout failed: " + error.message);
            }
        });
    </script>
</body>
</html>
