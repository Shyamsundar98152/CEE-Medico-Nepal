<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Quiz — CEE Medico Nepal</title>
<meta name="description" content="Daily scheduled chapter quiz — auto loads chapter by time and saves participant results locally" />
<style>
  :root{--blue:#003366;--accent:#0056b3;--card:#fff;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:#f3f6fb; color:#0f172a}
  header,footer{background:var(--blue); color:#fff; padding:14px 18px; text-align:center}
  main{max-width:980px; margin:20px auto; padding:18px}
  .card{background:var(--card); border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(2,6,23,0.06); margin-bottom:16px}
  h1{margin:0;font-size:1.3rem}
  h2{color:var(--blue); margin:6px 0 14px}
  .row{display:flex;gap:12px;align-items:center}
  .col{flex:1}
  #chapter-title{font-weight:600}
  .meta{color:var(--muted); font-size:0.95rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  input[type="text"], button, select {padding:10px;border-radius:8px;border:1px solid #e6eef8;font-size:1rem}
  button{background:var(--accent); color:white; border:0; cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .option-btn{display:block;width:100%;text-align:left;padding:12px;border-radius:10px;border:1px solid #e6eef8;margin:8px 0;background:#f8fcff;cursor:pointer}
  .option-btn:hover{background:#e8f6ff}
  #options-container{margin-top:8px}
  #quiz-results{display:flex;flex-direction:column;gap:8px;align-items:center}
  .participant{display:flex;justify-content:space-between;padding:6px 8px;border-radius:6px}
  .small{font-size:.9rem;color:var(--muted)}
  .center{text-align:center}
  .hidden{display:none !important;} /* Ensures hidden elements are truly hidden */
  @media (max-width:640px){.row{flex-direction:column;align-items:stretch}}

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background: var(--card);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    max-width: 400px;
    width: 90%;
    text-align: center;
  }
  .modal-content button {
    margin-top: 20px;
    padding: 10px 20px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
</style>
</head>
<body>
<header>
  <h1>CEE Medico — Daily Chapter Quiz</h1>
  <div class="small">Auto-load by schedule (Local time) • Results stored locally only</div>
</header>

<main>
  <div class="card">
    <div id="status">
      <div id="chapter-title">Loading schedule...</div>
      <div class="meta" id="schedule-info">Checking local time…</div>
    </div>
    <div style="margin-top:12px" id="controls-area">
      <div class="row">
        <div class="col">
          <input id="participant-name" type="text" placeholder="Your name (optional for local result)" />
        </div>
        <div>
          <button id="join-button" disabled>Wait for quiz</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Participant name is for your local reference only. Results are not saved externally.</div>
    </div>
  </div>

  <!-- Display Schedule -->
  <div class="card">
    <h3 style="margin-top:0">Upcoming Chapters</h3>
    <div id="schedule-display" class="leaderboard">
      No schedule loaded.
    </div>
  </div>


  <div id="quiz-area" class="card hidden">
    <div id="countdown" class="small center"></div>
    <div id="question-num" class="small"></div>
    <h2 id="question-text"></h2>
    <div id="options-container"></div>
    <div id="explanation" class="small center"></div>

    <div class="controls" style="margin-top:12px">
      <button id="prev-btn">Previous</button>
      <button id="skip-btn">Skip</button>
      <button id="next-btn">Next</button>
      <button id="submit-btn" style="background:#16a34a">Submit</button>
    </div>
  </div>

  <div id="results-area" class="card hidden">
    <div id="quiz-results">
      <h2 class="center">Quiz Result</h2>
      <div class="center">
        <div>Total: <span id="res-total">0</span></div>
        <div>Correct: <span id="res-correct">0</span></div>
        <div>Wrong: <span id="res-wrong">0</span></div>
        <div>Skipped: <span id="res-skipped">0</span></div>
      </div>
      <div style="margin-top:12px" class="center">
        <button id="save-result-btn">Save Result (Local)</button>
        <button id="restart-btn" style="background:#ef4444">Restart Quiz</button>
      </div>

      <!-- Leaderboard section removed as it's not applicable for local-only results -->
    </div>
  </div>

  <div class="card small" id="notes">
    <strong>Notes:</strong> The schedule is read from <code>chapters.txt</code> (as an uploaded file). The site uses your **local device's time** for scheduling. Quiz results are **only stored locally** within your browser and are not shared or saved to any external database.
  </div>
</main>

<footer>
  <div class="small">© 2025 CEE Medico Nepal</div>
</footer>

<!-- Modal for messages -->
<div id="modal-message-overlay" class="modal-overlay hidden">
  <div class="modal-content">
    <p id="modal-message-text"></p>
    <button id="modal-message-close">OK</button>
  </div>
</div>

<script type="module">
/* =========================
   Firebase Imports (ALL REMOVED)
   ========================= */
// No Firebase imports are needed as there is no external linking or authentication.

/* =========================
   CONFIG
   ========================= */
// TIME_API removed, using local time
const SCHEDULE_TXT_FILENAME = "chapters.txt"; // Reference to the uploaded file by its name
const GEMINI_API_KEY = ""; // Canvas environment will provide it at runtime.
const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;

/* =========================
   GLOBAL STATE & CANVAS VARS
   ========================= */
// app, auth, dbInstance removed
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Kept for consistency, but not strictly used
let userId = crypto.randomUUID(); // Used as a purely local unique ID for this session

let schedule = [];             // array of {time:Date, chapter:string}
let currentChapter = null;     // {time, chapter}
let quizData = [];             // array of questions from Gemini or data file
let index = 0;
let countdownTimer = null;
let questionTimer = null;
let participantName = "";
// leaderboardListener removed

/* =========================
   Helpers
   ========================= */
function sanitizeKey(s){
  return String(s).replace(/[^a-z0-9]/gi, '_').toLowerCase();
}
function el(id){ return document.getElementById(id); }
function show(q){ q.classList.remove('hidden'); q.style.display = ''; }
function hide(q){ q.classList.add('hidden'); q.style.display = 'none'; }

function showMessage(msg) {
    el('modal-message-text').innerText = msg;
    show(el('modal-message-overlay'));
}
el('modal-message-close').onclick = () => {
    hide(el('modal-message-overlay'));
};

/* =========================
   Firebase Initialization & Auth (REMOVED)
   ========================= */
// This function is no longer needed as there's no Firebase integration.
// async function initFirebase() { ... }


/* =========================
   Load schedule (chapters.txt)
   ========================= */
async function loadSchedule(){
  try{
    // Use content_fetcher to directly get the content of the uploaded chapters.txt file
    // The content_fetcher is a Canvas-specific tool that allows accessing uploaded files by their name.
    const fileContentRef = {id: 'chapters.txt', type: 'text/plain'}; // Assuming it's a plain text file
    const txt = await content_fetcher.fetch(fileContentRef);

    if(!txt) throw new Error("Schedule file content is empty or could not be retrieved. Please ensure 'chapters.txt' is uploaded.");

    schedule = txt.trim().split('\n').map(l=>{
      const parts = l.split('|');
      const dt = parts[0].trim(); // "YYYY-MM-DD HH:MM"
      const ch = (parts[1]||"").trim();
      const m = dt.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);
      if(!m) return null;
      const [_,y,mo,d,h,mi] = m;
      const dateObj = new Date(Number(y), Number(mo)-1, Number(d), Number(h), Number(mi), 0, 0);
      return {time: dateObj, chapter: ch};
    }).filter(Boolean).sort((a,b)=>a.time - b.time);

    // Display schedule on the page
    renderSchedule();

  }catch(e){
    console.error("Error loading schedule:", e);
    schedule = [];
    el('chapter-title').innerText = `Error loading schedule: ${e.message}.`;
    el('schedule-display').innerHTML = `<div class="small">Error loading schedule: ${e.message}</div>`;
  }
}

/* =========================
   Render Schedule on the page
   ========================= */
function renderSchedule() {
  const scheduleDisplayEl = el('schedule-display');
  if (schedule.length === 0) {
    scheduleDisplayEl.innerHTML = '<div class="small">No upcoming chapters scheduled.</div>';
    return;
  }
  const now = new Date();
  const upcomingSchedule = schedule.filter(entry => entry.time >= now);

  if (upcomingSchedule.length === 0) {
    scheduleDisplayEl.innerHTML = '<div class="small">All scheduled quizzes have passed.</div>';
    return;
  }

  scheduleDisplayEl.innerHTML = upcomingSchedule.map(entry => {
    const timeStr = entry.time.toLocaleString('en-NP', {
      year: 'numeric', month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit', hour12: true
    });
    return `<div class="participant"><div>${escapeHtml(entry.chapter)}</div><div>${timeStr}</div></div>`;
  }).join('');
}


/* =========================
   Get accurate Nepal time (local device time)
   ========================= */
async function getAccurateTime(){
  // Using local device time as per request
  return new Date();
}

/* =========================
   Find latest chapter <= now
   ========================= */
function pickCurrentChapter(now){
  let picked = null;
  for(const entry of schedule){
    if(now >= entry.time) picked = entry;
  }
  return picked;
}

/* =========================
   Database functions (ALL REMOVED)
   ========================= */
// resetParticipantsInDB, pushParticipantResult, loadLeaderboard are no longer needed.


/* =========================
   Gemini generate (50 MCQs)
   ========================= */
async function generateMCQs(chapter){
  el('chapter-title').innerText = `Generating questions for "${chapter}" — please wait...`;
  const prompt = `
Generate 50 NEET / CEE-level multiple choice questions in JSON (array) on the chapter "${chapter}" based on NEB / MEC syllabus Nepal. Use exactly this schema:
[
  {
    "question": "text",
    "options": ["A","B","C","D"],
    "correct": 0, // index 0..3
    "explanation": "short explanation"
  }
]
Return JSON only.
`.trim();

  const payload = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: { responseMimeType: "application/json" }
  };

  try{
    const r = await fetch(`${GEMINI_URL}`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){
      const errText = await r.text();
      throw new Error(`Gemini API failed: ${r.status} - ${errText}`);
    }
    const json = await r.json();
    const raw = json?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = JSON.parse(raw);
    return parsed;
  }catch(e){
    console.error("Gemini error", e);
    throw e;
  }
}

/* =========================
   Quiz UI functions
   ========================= */
function renderQuestion(){
  if(!quizData.length) return;
  const q = quizData[index];
  el('question-num').innerText = `Question ${index+1} / ${quizData.length}`;
  el('question-text').innerText = q.question || '';
  el('explanation').innerText = ''; // Clear previous explanation
  const cont = el('options-container'); cont.innerHTML = ''; // Clear previous options

  (q.options||[]).forEach((opt,i)=>{
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.innerText = opt;
    btn.onclick = ()=>{
      if(q.answered) return; // Prevent re-answering
      q.answered = true;
      q.userAnswer = i;

      // Visually mark chosen option
      Array.from(cont.children).forEach(optionBtn => {
        optionBtn.style.background = '#f8fcff'; // Reset all to default
        optionBtn.style.border = '1px solid #e6eef8';
      });

      // Mark correct/incorrect choice
      if (i === q.correct) {
        btn.style.background = '#d1fae5'; // Light green for correct
        btn.style.border = '1px solid #34d399';
      } else {
        btn.style.background = '#ffe4e6'; // Light red for incorrect
        btn.style.border = '1px solid #ef4444';
        // Also highlight the correct answer if incorrect choice was made
        if (q.correct !== undefined && q.correct !== null && Array.from(cont.children)[q.correct]) {
            Array.from(cont.children)[q.correct].style.background = '#d1fae5';
            Array.from(cont.children)[q.correct].style.border = '1px solid #34d399';
        }
      }

      el('explanation').innerText = (i === q.correct ? '✅ Correct. ' : '❌ Incorrect. Correct answer: ' + (q.options && q.options[q.correct] ? q.options[q.correct] : '')) + (q.explanation ? ' — ' + q.explanation : '');
      clearInterval(questionTimer); // Stop timer after answer
    };
    cont.appendChild(btn);
  });
  startQuestionTimer(); // Start timer for the new question
}

function nextQuestion(){
  if(index < quizData.length -1){
    // If current question wasn't answered, mark as skipped
    if (!quizData[index].answered) {
      quizData[index].skipped = true;
    }
    index++; renderQuestion();
  }
  else submitQuiz();
}
function prevQuestion(){
  if(index>0){
    index--; renderQuestion();
  }
}
function skipQuestion(){
  quizData[index].skipped = true;
  if (!quizData[index].answered) { // Only mark as skipped if not already answered
    quizData[index].answered = true; // Mark as answered to prevent re-interaction
    quizData[index].userAnswer = null; // No answer
  }
  index++;
  if(index<quizData.length) { renderQuestion(); }
  else submitQuiz();
}

function startQuestionTimer(){
  let timeLeft = 30;
  el('countdown').innerText = `Time: ${timeLeft}s`;
  if(questionTimer) clearInterval(questionTimer);
  questionTimer = setInterval(()=> {
    timeLeft--;
    el('countdown').innerText = `Time: ${timeLeft}s`;
    if(timeLeft<=0){
      clearInterval(questionTimer);
      // auto-skip
      if (!quizData[index].answered) { // Only mark as skipped if not already answered
        quizData[index].skipped = true;
        quizData[index].answered = true;
        quizData[index].userAnswer = null;
      }
      if(index < quizData.length -1){ index++; renderQuestion(); }
      else submitQuiz();
    }
  },1000);
}

function submitQuiz(){
  if(questionTimer) clearInterval(questionTimer);
  // tally
  let correct=0, wrong=0, skipped=0;
  quizData.forEach(q=>{
    if(q.answered && q.userAnswer !== null && q.userAnswer === q.correct) correct++;
    else if(q.answered && q.userAnswer !== null && q.userAnswer !== q.correct) wrong++;
    else if(q.skipped || (!q.answered && q.userAnswer === null)) skipped++; // Count as skipped if explicitly skipped or not answered
  });
  el('res-total').innerText = quizData.length;
  el('res-correct').innerText = correct;
  el('res-wrong').innerText = wrong;
  el('res-skipped').innerText = skipped;
  // show results area
  hide(el('quiz-area'));
  show(el('results-area'));
  // "Save Result" button's functionality changed to local feedback
  el('save-result-btn').disabled = false; // Always enabled for local feedback
}

/* =========================
   Event wiring
   ========================= */
document.addEventListener('click', (e) => {
  if(e.target && e.target.id === 'join-button'){
    participantName = el('participant-name').value.trim();
    // No strict requirement for name if not saving to DB, but keep for local reference if user enters it
    
    hide(el('results-area'));
    show(el('quiz-area'));
    if(quizData.length) { index=0; renderQuestion(); }
  }
});
el('prev-btn').onclick = prevQuestion;
el('next-btn').onclick = nextQuestion;
el('skip-btn').onclick = skipQuestion;
el('submit-btn').onclick = submitQuiz;
el('restart-btn').onclick = ()=>{
  location.reload();
};
el('save-result-btn').onclick = async ()=>{
  // Modified to just show a local message, no database interaction
  showMessage('Your quiz result has been processed locally!');
};

/* =========================
   Main routine: load schedule, pick chapter, generate or load MCQs
   ========================= */
async function main(){
  // Load schedule first
  await loadSchedule();

  // Get accurate time (local device time)
  const now = await getAccurateTime();
  el('schedule-info').innerText = `Current local time: ${now.toLocaleString('en-NP', {dateStyle: 'full', timeStyle: 'medium'})}`;

  // Pick appropriate chapter based on current time
  currentChapter = pickCurrentChapter(now);
  if(!currentChapter){
    el('chapter-title').innerText = 'No chapter scheduled yet (or schedule missing/future).';
    el('join-button').disabled = true;
    return;
  }
  el('chapter-title').innerText = `Scheduled: ${currentChapter.chapter} (starts ${currentChapter.time.toLocaleString('en-NP', {dateStyle: 'medium', timeStyle: 'short'})})`;

  // Generate MCQs (Gemini) — this can take a few seconds
  try{
    quizData = await generateMCQs(currentChapter.chapter);
    // Ensure structure and add initial state for each question
    quizData = quizData.map(q => ({ ...q, answered:false, userAnswer:null, skipped:false }));
    el('join-button').innerText = 'Join Quiz';
    el('join-button').disabled = false;
  }catch(e){
    el('chapter-title').innerText = `Error generating questions: ${e.message || e}`;
    el('join-button').innerText = 'Retry';
    el('join-button').disabled = false;
    el('join-button').onclick = ()=> location.reload();
  }
}

// Start the main application logic when the page loads
document.addEventListener('DOMContentLoaded', main);

/* =========================
   small helper: escape html
   ========================= */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
</script>
</body>
</html>
