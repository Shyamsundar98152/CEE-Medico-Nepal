<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Quiz — CEE Medico Nepal</title>
<meta name="description" content="Daily scheduled chapter quiz — auto loads chapter by time and saves participant results to Realtime DB" />
<style>
  :root{--blue:#003366;--accent:#0056b3;--card:#fff;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:#f3f6fb; color:#0f172a}
  header,footer{background:var(--blue); color:#fff; padding:14px 18px; text-align:center}
  main{max-width:980px; margin:20px auto; padding:18px}
  .card{background:var(--card); border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(2,6,23,0.06); margin-bottom:16px}
  h1{margin:0;font-size:1.3rem}
  h2{color:var(--blue); margin:6px 0 14px}
  .row{display:flex;gap:12px;align-items:center}
  .col{flex:1}
  #chapter-title{font-weight:600}
  .meta{color:var(--muted); font-size:0.95rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  input[type="text"], button, select {padding:10px;border-radius:8px;border:1px solid #e6eef8;font-size:1rem}
  button{background:var(--accent); color:white; border:0; cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .option-btn{display:block;width:100%;text-align:left;padding:12px;border-radius:10px;border:1px solid #e6eef8;margin:8px 0;background:#f8fcff;cursor:pointer}
  .option-btn:hover{background:#e8f6ff}
  #options-container{margin-top:8px}
  #quiz-results{display:flex;flex-direction:column;gap:8px;align-items:center}
  .leaderboard{max-height:220px; overflow:auto; margin-top:10px;border-radius:8px;padding:8px;border:1px dashed #e6eef8}
  .participant{display:flex;justify-content:space-between;padding:6px 8px;border-radius:6px}
  .small{font-size:.9rem;color:var(--muted)}
  .center{text-align:center}
  @media (max-width:640px){.row{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
<header>
  <h1>CEE Medico — Daily Chapter Quiz</h1>
  <div class="small">Auto-load by schedule (Nepal time) • Results saved to Realtime DB</div>
</header>

<main>
  <div class="card">
    <div id="status">
      <div id="chapter-title">Loading schedule...</div>
      <div class="meta" id="schedule-info">Checking time…</div>
    </div>
    <div style="margin-top:12px" id="controls-area">
      <div class="row">
        <div class="col">
          <input id="participant-name" type="text" placeholder="Your name (required to save result)" />
        </div>
        <div>
          <button id="join-button" disabled>Wait for quiz</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Participant name will be stored with score. If empty, result won't be saved.</div>
    </div>
  </div>

  <div id="quiz-area" class="card hidden">
    <div id="countdown" class="small center"></div>
    <div id="question-num" class="small"></div>
    <h2 id="question-text"></h2>
    <div id="options-container"></div>
    <div id="explanation" class="small center"></div>

    <div class="controls" style="margin-top:12px">
      <button id="prev-btn">Previous</button>
      <button id="skip-btn">Skip</button>
      <button id="next-btn">Next</button>
      <button id="submit-btn" style="background:#16a34a">Submit</button>
    </div>
  </div>

  <div id="results-area" class="card hidden">
    <div id="quiz-results">
      <h2 class="center">Quiz Result</h2>
      <div class="center">
        <div>Total: <span id="res-total">0</span></div>
        <div>Correct: <span id="res-correct">0</span></div>
        <div>Wrong: <span id="res-wrong">0</span></div>
        <div>Skipped: <span id="res-skipped">0</span></div>
      </div>
      <div style="margin-top:12px" class="center">
        <button id="save-result-btn">Save Result</button>
        <button id="restart-btn" style="background:#ef4444">Restart Quiz</button>
      </div>

      <h3 style="margin-top:10px">Leaderboard — Current Quiz</h3>
      <div class="leaderboard" id="leaderboard"></div>
    </div>
  </div>

  <div class="card small" id="notes">
    <strong>Notes:</strong> The schedule is read from <code>data/chapters.txt</code>. The site uses <code>worldtimeapi.org</code> for Nepal time. Realtime DB updates are sent to your database root under <code>/quizzes/{chapterKey}/participants</code>.
  </div>
</main>

<footer>
  <div class="small">© 2025 CEE Medico Nepal</div>
</footer>

<script>
/* =========================
   CONFIG - EDIT IF NEEDED
   ========================= */
const TIME_API = "https://worldtimeapi.org/api/timezone/Asia/Kathmandu";
const SCHEDULE_TXT = "data/chapters.txt";
const GEMINI_API_KEY = "AIzaSyA3ASMxIv3OwlLmAFvO1pSGJe6U1PdvH2E"; // YOUR provided key
const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
const FIREBASE_DB_ROOT = "https://daily-quiz-a29e8-default-rtdb.asia-southeast1.firebasedatabase.app";

/* =========================
   STATE
   ========================= */
let schedule = [];             // array of {time:Date, chapter:string}
let currentChapter = null;     // {time, chapter}
let quizData = [];             // array of questions from Gemini or data file
let index = 0;
let countdownTimer = null;
let questionTimer = null;
let participantName = "";
let participantsPath = "";     // DB path where current participants are stored

/* =========================
   Helpers
   ========================= */
function sanitizeKey(s){
  return s.replace(/[^a-z0-9]/gi, '_').toLowerCase();
}
function el(id){ return document.getElementById(id); }
function show(q){ q.classList.remove('hidden'); q.style.display = ''; }
function hide(q){ q.classList.add('hidden'); q.style.display = 'none'; }

/* =========================
   Load schedule (chapters.txt)
   ========================= */
async function loadSchedule(){
  try{
    const res = await fetch(SCHEDULE_TXT);
    if(!res.ok) throw new Error("Schedule file not found");
    const txt = await res.text();
    schedule = txt.trim().split('\\n').map(l=>{
      const parts = l.split('|');
      const dt = parts[0].trim(); // "YYYY-MM-DD HH:MM"
      const ch = (parts[1]||"").trim();
      // treat dt as local time: construct using parts to avoid timezone shift
      // dt is in "YYYY-MM-DD HH:MM"
      const m = dt.match(/(\\d{4})-(\\d{2})-(\\d{2})\\s+(\\d{2}):(\\d{2})/);
      if(!m) return null;
      const [_,y,mo,d,h,mi] = m;
      // Create a Date object in local timezone with those components
      const dateObj = new Date(Number(y), Number(mo)-1, Number(d), Number(h), Number(mi), 0, 0);
      return {time: dateObj, chapter: ch};
    }).filter(Boolean).sort((a,b)=>a.time - b.time);
  }catch(e){
    console.error("Error loading schedule:", e);
    schedule = [];
  }
}

/* =========================
   Get accurate Nepal time (fallback to local)
   ========================= */
async function getAccurateTime(){
  try{
    const r = await fetch(TIME_API, {cache:"no-store"});
    if(!r.ok) throw new Error("Time API failed");
    const j = await r.json();
    return new Date(j.datetime);
  }catch(e){
    console.warn("Time API failed; using local clock", e);
    return new Date();
  }
}

/* =========================
   Find latest chapter <= now
   ========================= */
function pickCurrentChapter(now){
  let picked = null;
  for(const entry of schedule){
    if(now >= entry.time) picked = entry;
  }
  return picked;
}

/* =========================
   Reset participants in DB for new chapter
   ========================= */
async function resetParticipantsInDB(chapterKey){
  try{
    const path = `/quizzes/${chapterKey}/participants.json`;
    const url = FIREBASE_DB_ROOT.replace(/\\/$/,'') + path;
    // PUT empty object (reset)
    await fetch(url, { method: 'PUT', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({}) });
    console.log("Participants reset for", chapterKey);
  }catch(e){
    console.error("Reset error", e);
  }
}

/* =========================
   Push participant result to DB
   ========================= */
async function pushParticipantResult(chapterKey, name, scoreObj){
  try{
    const path = `/quizzes/${chapterKey}/participants.json`;
    const url = FIREBASE_DB_ROOT.replace(/\\/$/,'') + path;
    const payload = {
      name: name,
      score: scoreObj.correct,
      correct: scoreObj.correct,
      wrong: scoreObj.wrong,
      skipped: scoreObj.skipped,
      timestamp: new Date().toISOString()
    };
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error("Failed to save result");
    return await res.json();
  }catch(e){
    console.error("Push participant error", e);
    throw e;
  }
}

/* =========================
   Read participants and render leaderboard
   ========================= */
async function loadLeaderboard(chapterKey){
  try{
    const path = `/quizzes/${chapterKey}/participants.json`;
    const url = FIREBASE_DB_ROOT.replace(/\\/$/,'') + path;
    const r = await fetch(url);
    if(!r.ok) { el('leaderboard').innerHTML = '<div class="small">No data</div>'; return; }
    const data = await r.json();
    if(!data){ el('leaderboard').innerHTML = '<div class="small">No participants yet</div>'; return; }
    const rows = Object.values(data);
    rows.sort((a,b)=> (b.score||0) - (a.score||0) );
    el('leaderboard').innerHTML = rows.map(p=>`<div class="participant"><div>${escapeHtml(p.name||'—')}</div><div>${p.score||0}</div></div>`).join('');
  }catch(e){
    console.error("Leaderboard load error", e);
    el('leaderboard').innerHTML = '<div class="small">Error loading leaderboard</div>';
  }
}

/* =========================
   Gemini generate (50 MCQs)
   ========================= */
async function generateMCQs(chapter){
  el('chapter-title').innerText = `Generating questions for "${chapter}" — please wait...`;
  const prompt = `
Generate 50 NEET / CEE-level multiple choice questions in JSON (array) on the chapter "${chapter}" based on NEB / MEC syllabus Nepal. Use exactly this schema:
[
  {
    "question": "text",
    "options": ["A","B","C","D"],
    "correct": 0, // index 0..3
    "explanation": "short explanation"
  }
]
Return JSON only.
`.trim();

  const payload = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: { responseMimeType: "application/json" }
  };

  try{
    const r = await fetch(`${GEMINI_URL}`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){
      const err = await r.text();
      throw new Error('Gemini API failed: ' + (err||r.status));
    }
    const json = await r.json();
    // The response usually contains result.candidates[0].content.parts[0].text
    const raw = json?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = JSON.parse(raw);
    return parsed;
  }catch(e){
    console.error("Gemini error", e);
    throw e;
  }
}

/* =========================
   Quiz UI functions
   ========================= */
function renderQuestion(){
  if(!quizData.length) return;
  const q = quizData[index];
  el('question-num').innerText = `Question ${index+1} / ${quizData.length}`;
  el('question-text').innerText = q.question || '';
  el('explanation').innerText = '';
  const cont = el('options-container'); cont.innerHTML = '';
  (q.options||[]).forEach((opt,i)=>{
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.innerText = opt;
    btn.onclick = ()=>{
      if(q.answered) return;
      q.answered = true;
      q.userAnswer = i;
      // mark
      btn.style.background = (i === q.correct)?'#d1fae5':'#ffe4e6';
      el('explanation').innerText = (i===q.correct? '✅ Correct. ':'❌ Incorrect. Correct: ' + (q.options[q.correct] || '')) + (q.explanation? ' — '+q.explanation:'');
      clearInterval(questionTimer);
    };
    cont.appendChild(btn);
  });
}

function nextQuestion(){
  if(index < quizData.length -1){ index++; renderQuestion(); startQuestionTimer(); }
  else submitQuiz();
}
function prevQuestion(){ if(index>0){ index--; renderQuestion(); startQuestionTimer(); } }
function skipQuestion(){ quizData[index].skipped = true; index++; if(index<quizData.length) { renderQuestion(); startQuestionTimer(); } else submitQuiz(); }

function startQuestionTimer(){
  let timeLeft = 30;
  el('countdown').innerText = `Time: ${timeLeft}s`;
  if(questionTimer) clearInterval(questionTimer);
  questionTimer = setInterval(()=> {
    timeLeft--;
    el('countdown').innerText = `Time: ${timeLeft}s`;
    if(timeLeft<=0){
      clearInterval(questionTimer);
      // auto-skip
      quizData[index].skipped = true;
      if(index < quizData.length -1){ index++; renderQuestion(); startQuestionTimer(); }
      else submitQuiz();
    }
  },1000);
}

function submitQuiz(){
  if(questionTimer) clearInterval(questionTimer);
  // tally
  let correct=0, wrong=0, skipped=0;
  quizData.forEach(q=>{
    if(q.answered && q.userAnswer === q.correct) correct++;
    else if(q.answered && q.userAnswer !== q.correct) wrong++;
    else skipped++;
  });
  el('res-total').innerText = quizData.length;
  el('res-correct').innerText = correct;
  el('res-wrong').innerText = wrong;
  el('res-skipped').innerText = skipped;
  // show results area
  hide(el('quiz-area'));
  show(el('results-area'));
  // enable save result if name provided
  el('save-result-btn').disabled = !el('participant-name').value.trim();
  // show leaderboard
  loadLeaderboard(sanitizeKey(currentChapter.chapter));
}

/* =========================
   Event wiring
   ========================= */
document.addEventListener('click', (e) => {
  if(e.target && e.target.id === 'join-button'){
    participantName = el('participant-name').value.trim();
    if(!participantName){ alert('Enter your name to join and save result.'); return; }
    // enable quiz UI (if quizData already ready)
    hide(el('results-area'));
    show(el('quiz-area'));
    // if quizData is empty, it will be generated already; otherwise render first q
    if(quizData.length) { index=0; renderQuestion(); startQuestionTimer(); }
  }
});
el('prev-btn').onclick = prevQuestion;
el('next-btn').onclick = nextQuestion;
el('skip-btn').onclick = skipQuestion;
el('submit-btn').onclick = submitQuiz;
el('restart-btn').onclick = ()=>{
  // reload page to allow re-join
  location.reload();
};
el('save-result-btn').onclick = async ()=>{
  try{
    const correct = Number(el('res-correct').innerText||0);
    const wrong = Number(el('res-wrong').innerText||0);
    const skipped = Number(el('res-skipped').innerText||0);
    const chapterKey = sanitizeKey(currentChapter.chapter);
    await pushParticipantResult(chapterKey, el('participant-name').value.trim(), {correct,wrong,skipped});
    alert('Result saved ✅');
    // refresh leaderboard
    await loadLeaderboard(chapterKey);
  }catch(e){
    alert('Failed to save result. Check console for details.');
  }
};

/* =========================
   Main routine: load schedule, pick chapter, generate or load MCQs,
   reset participants if new chapter
   ========================= */
async function main(){
  await loadSchedule();
  const now = await getAccurateTime();
  el('schedule-info').innerText = `Current Nepal time: ${now.toLocaleString()}`;
  // pick appropriate chapter
  currentChapter = pickCurrentChapter(now);
  if(!currentChapter){
    el('chapter-title').innerText = 'No chapter scheduled yet (or schedule missing)';
    el('join-button').disabled = true;
    return;
  }
  el('chapter-title').innerText = `Scheduled: ${currentChapter.chapter} (starts ${currentChapter.time.toLocaleString()})`;

  // detect if we've already initialized this chapter earlier (localStorage)
  const storedKey = localStorage.getItem('current_chapter_key') || '';
  const thisKey = sanitizeKey(currentChapter.chapter);
  participantsPath = `/quizzes/${thisKey}/participants`;

  if(storedKey !== thisKey){
    // New chapter activated — reset participants in DB for clean start
    try{
      await resetParticipantsInDB(thisKey);
    }catch(e){
      console.warn("Could not reset participants in DB:", e);
    }
    localStorage.setItem('current_chapter_key', thisKey);
  }

  // If chapter scheduled time is in future (but was picked because schedule date/time <= now),
  // The pickCurrentChapter already ensures time <= now. So quiz is ready.
  // Now generate MCQs (Gemini) — this can take a few seconds
  try{
    quizData = await generateMCQs(currentChapter.chapter);
    // ensure structure
    quizData = quizData.map(q => ({ ...q, answered:false, userAnswer:null, skipped:false }));
    el('join-button').innerText = 'Join Quiz';
    el('join-button').disabled = false;
    // show leaderboard initial
    loadLeaderboard(thisKey);
  }catch(e){
    el('chapter-title').innerText = `Error generating questions: ${e.message || e}`;
    el('join-button').innerText = 'Retry';
    el('join-button').disabled = false;
    el('join-button').onclick = ()=> location.reload();
  }
}

main();
 
/* =========================
   small helper: escape html
   ========================= */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
</script>
</body>
</html>
